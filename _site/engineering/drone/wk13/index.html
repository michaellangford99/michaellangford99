
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="google-site-verification" content="jWYz4n1G8T7OHT4uWrEfZc6Qx-KFsPUYCC6oLXvfJHs">

    <!-- Bootstrap CSS -->
   <title>ECE477 Drone - Week 13</title> 
   
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!---<link rel="stylesheet" href="/assets/css/prism-vsc-dark-plus.css"/>  -->
    <!---<link href="https://unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/assets/css/prism-vs.css">
    <link rel="stylesheet" href="/assets/css/clean-blog.css">
    
  <style id="MJX-SVG-styles">
mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}
</style></head>
  <body>


<nav class="navbar navbar-expand-lg bg-body-tertiary bg-dark border-bottom border-bottom-dark d-print-none" data-bs-theme="dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Michaelangelo</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">

    
    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
      <li class="nav-item">
        <a class="nav-link" href="/hiking/">Hiking &amp; Photography</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/engineering/">Engineering</a>
      </li>
    </ul>

<!--
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="#">Home</a>
        </li>

        <li class="nav-item"><a class="nav-link" href="#">Hiking & Photograpy</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Engineering</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Computer Graphics</a></li>       
        <li class="nav-item"><a class="nav-link" href="#">Thoughts</a></li>
        
        
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Dropdown
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">Action</a></li>
            <li><a class="dropdown-item" href="#">Another action</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">Something else here</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled">Disabled</a>
        </li>


      </ul>
-->

      <!--<form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Search</button>
      </form>-->
    </div>
  </div>
</nav>
    
<div class="bg-image p-5 text-center shadow-1-strong mb-2 text-white d-print-none" style="background-image: url('/assets/images/crestone.jpg'); background-position: center; background-size:cover;">
<div style="padding: 100px 0 130px ">
  <h1 class="mb-2 h1">ECE477 Drone - Week 13</h1>
  <p>
    
  </p>
</div>
</div>

<!--<div class="container-md">
  <div class="alert alert-primary" role="alert">
    
  </div>
</div>-->

    <div class="container-md d-print-none">
        <div class="row justify-content-center">
            
            <div class="col-md-9 mr-auto ml-auto">
                 <h1>Week 13</h1>
<p><strong>PCB</strong></p>
<p>After last week’s less than excellent progress after bricking a chip trying to get the IMU working, I decided to use the hot plate and reflow the entire top of the PCB in one shot. (Unfortunately, I didn’t get pictures of the stencil and reflow process, I was a little rushed) I started by organizing all the parts on a printout I developed last week to help place the parts with the right values in the right spots. I also ordered a bunch of 0.1uF 0603 caps, and 0603 LEDs so I wouldn’t have to ‘borrow’ some from some of my other boards.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-1. Parts layout before placement"><figcaption class="figure-caption text-center" align="center">Fig. 13-1. Parts layout before placement</figcaption></figure></div></p>
<p>With this all ready, I got the stencil ready for use. The stencil we purchased with our board came as a very large thin sheet of metal, with the small cutouts for our board in the center. This was way to large to use as is, so I used the metal sheet cutter to cut it down to size first. With the stencil ready, I set up the board to be stenciled by using a metal right-angle of equal thickness to the PCB to secure the PCB on the table, and then taped the stencil down onto the PCB like a hinge, ensuring each little slot lined up with the correct pad.</p>
<p>Then Joe prepared the solder paste, waiting for it to get slightly warmer than the refrigerator it is stored in, and then we applied it to the stencil by scraping it across with a credit card-like tool. After a couple tries, we got the right amount of solder applied without it smearing around the pads and shorting nearby pads.</p>
<p>Then I took the PCB with paste back to my station, and carefully placed each part onto it’s pads with tweezers, carefully aligning and double-checking them. Once I was confident the placement was correct and aligned, Joe helped me use the (very hot) hot plate to preheat my PCB, and then reflow the paste on the PCB. It was very cool to see the paste boil, the solder melt, and all the components float into place as the solder glistens. After the PCB cooled down, I washed it off and took a look at the results.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-1.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-2. PCB after reflow, note shorts on multiple parts"><figcaption class="figure-caption text-center" align="center">Fig. 13-2. PCB after reflow, note shorts on multiple parts</figcaption></figure></div></p>
<p>Nearly all the components were soldered correctly, but both IMUs, the micro, and the USB connector had shorts due to excess solder paste. The IMU joints were easy to clear, but the micro was surprisingly difficult. Joe had to help me clear them, but afterwards it looked quite nice. The USB was the most frustrating, as it had bridged ID and ground, and VUSB and ground. Anything shorted to ground on the USB connector is difficult to fix, as the USB connector sucks all the heat away as the iron tries to melt the joints. ID I left shorted, as the board doesn’t use it and the bus doesn’t care, but I was able to successfully clear the bridge with VUSB with lots of heat and flux.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-2.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-3. PCB after shorts fixed."><figcaption class="figure-caption text-center" align="center">Fig. 13-3. PCB after shorts fixed.</figcaption></figure></div></p>
<p>Once the top of the PCB was complete, I went back and hand-soldered each cap onto the back of the PCB. This was pretty easy after doing the first board thankfully. After adding the 3.3V regulator, the board was ready to test.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-3.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-4. Back side of PCB after hand-soldering all caps and regulator."><figcaption class="figure-caption text-center" align="center">Fig. 13-4. Back side of PCB after hand-soldering all caps and regulator.</figcaption></figure></div></p>
<p>Testing simply consisted of lots of continuity checks (and checks for shorts), and powering the board from the 3.3V supply on the programmer. With LEDs coming on properly, I programmed the board successfully with a ‘blink LED’ test program and then proceeded to test the USB-serial as well. Surprisingly, all hardware, even the IMU, worked first try. Good stuff.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-4.png" class="figure-img img-fluid rounded" alt="alt text" title=" "><figcaption class="figure-caption text-center" align="center"> </figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-5.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-5. Power-up and testing of USB->Serial"><figcaption class="figure-caption text-center" align="center">Fig. 13-5. Power-up and testing of USB-&gt;Serial</figcaption></figure></div></p>
<p><strong>Mechanical</strong></p>
<p>Jon got the mounting bracket for the flight controller printed this week, so I tried to get it mounted, and see if it needed any changes and a reprint. After removing the raft and support material, and cleaning off the thin wisps of print material, the bracket was looking good.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-6.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-6. Flight controller mounting bracket after printing"><figcaption class="figure-caption text-center" align="center">Fig. 13-6. Flight controller mounting bracket after printing</figcaption></figure></div></p>
<p>An initial evaluation revealed however that I had forgotten a couple very important components when designing this, the motor cables and the motor controller clearance. As can be seen in Fig. 7, the bracket doesn’t leave any space between the screw holes for the motor cables to pass under, as well as coming real close to the top of the motor controller.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-7.png" class="figure-img img-fluid rounded" alt="alt text" title=" "><figcaption class="figure-caption text-center" align="center"> </figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-8.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-7. Clearance and cable issues with flight controller mount"><figcaption class="figure-caption text-center" align="center">Fig. 13-7. Clearance and cable issues with flight controller mount</figcaption></figure></div></p>
<p>These issues didn’t seem to be solvable without damaging the mount, or modification of the motor cable routing (which I definitely didn’t want to change), so I decided to make some modifications and reprint.</p>
<p>I fixed both issues by extruding the part of the bracket that surrounds the mounting screws, but leaving space for the motor cables – this increased the clearance while making space for the wires, solving (I hope) both issues.</p>
<p>I’ve sent this print to Jon, so he’ll hopefully have this printed soon so we can get flying.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-9.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-8. Edited bracket after changes"><figcaption class="figure-caption text-center" align="center">Fig. 13-8. Edited bracket after changes</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-10.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-9. Fixed bracket in place within assembly"><figcaption class="figure-caption text-center" align="center">Fig. 13-9. Fixed bracket in place within assembly</figcaption></figure></div></p>
<p><strong>Clock Tree</strong></p>
<p>With the hardware on the board working, I decided it was the right time to fix an issue I’d been ignoring and waiting to fix, namely the clock speed. The STM32F446 can run up to 180MHz, which is much of why we chose it over other STM32F4 options. However the default clock settings at startup use the HSI (High Speed Internal) RC oscillator, without PLL, which runs the chip at a relatively sluggish 16MHz. The PCB was designed with the use of an external 16MHz crystal oscillator for higher precision, but also use of the internal PLLs and multipliers available to run the system clock at 180MHZ, and the peripheral clocks at their max speed.</p>
<p>So this week I spent multiple hours changing the clock and PLL settings to select (for now) the HSI, but to direct it through the PLLs available to multiply the clock rate up to 180MHz. To help with this, I used the CubeMX editor to play with clock tree values, and then when I was confident they were right, I edited the PLL and clock setup code to reflect those choices. Once this was working, I had to go through each peripheral and determine if it was running at the speed I thought it was, and edit #defines to properly calculate their clock speed off of the PLLs and divisor settings I selected.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-11.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-10. PLL and divisor settings used on the Micro"><figcaption class="figure-caption text-center" align="center">Fig. 13-10. PLL and divisor settings used on the Micro</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-12.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13- 11. Verifying that SPI CLK signal runs at the expected 90MHz / 256 = 352.6KHz during testing"><figcaption class="figure-caption text-center" align="center">Fig. 13- 11. Verifying that SPI CLK signal runs at the expected 90MHz / 256 = 352.6KHz during testing</figcaption></figure></div></p>
<p><strong>Motors &amp; Radio</strong></p>
<p>This week I also fixed multiple bugs in the motor code such that the max throttle range is used, and with the highest possible fidelity. I had an issue where I was using a range from 0-100,000, and then storing that un a uint16 -&gt; resulting in overflow and rollover. This caused a dangerous situation where the motors would ramp from full speed to stopped instantly, causing a huge current draw and heating up the motors and the ESC.</p>
<div id="4aSOW4n8nL4" class="eleventy-plugin-youtube-embed" style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/4aSOW4n8nL4" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p><strong>IMU</strong></p>
<p>Lastly, I put quite a bit of time into calibrating and adapting the IMU software to filter and combine the accelerometer and gyroscope. The gyro, after fixing some timing issues, worked on the PCB just as it had before on the dev board, with the gyro raw rate being properly converted into degrees per second. Most of all, I increased the SPI bus speed from a divisor=256 from the APB2 peripheral clock (90MHz down to 351kHz) to a divisor=32 (90MHz down to 2.8MHz).
For the accelerometer, I had to write a similar calibration sequence to the gyroscope, except that the accelerometer has one axis with a constant bias from gravity, so that has to be removed prior to the calibration phase, so that the calibration value doesn’t roll over as it gets summed up. I also converted the raw values (-32768 to 32767) to a floating point, where 1.0f maps to +1G (9.81 m/s^2).</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-18.png" class="figure-img img-fluid rounded" alt="alt text" title="Signal processing chain block diagram"><figcaption class="figure-caption text-center" align="center">Signal processing chain block diagram</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-19.png" class="figure-img img-fluid rounded" alt="alt text" title="IMU to motor output data flow"><figcaption class="figure-caption text-center" align="center">IMU to motor output data flow</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-13.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-13. Normalized accelerometer data"><figcaption class="figure-caption text-center" align="center">Fig. 13-13. Normalized accelerometer data</figcaption></figure></div></p>
<p>I also created a very simple IIR filter for the accelerometer data, single pole:</p>
<p><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="29.052ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 12840.9 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-1-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-N-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path><path id="MJX-1-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-N-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path><path id="MJX-1-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-1-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-1-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-1-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-1-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D466" xlink:href="#MJX-1-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(490,0)"><use data-c="5B" xlink:href="#MJX-1-TEX-N-5B"></use></g><g data-mml-node="mi" transform="translate(768,0)"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(1368,0)"><use data-c="5D" xlink:href="#MJX-1-TEX-N-5D"></use></g><g data-mml-node="mo" transform="translate(1923.8,0)"><use data-c="3D" xlink:href="#MJX-1-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(2979.6,0)"><use data-c="1D458" xlink:href="#MJX-1-TEX-I-1D458"></use></g><g data-mml-node="mi" transform="translate(3500.6,0)"><use data-c="1D466" xlink:href="#MJX-1-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(3990.6,0)"><use data-c="5B" xlink:href="#MJX-1-TEX-N-5B"></use></g><g data-mml-node="mi" transform="translate(4268.6,0)"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(5090.8,0)"><use data-c="2212" xlink:href="#MJX-1-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(6091,0)"><use data-c="31" xlink:href="#MJX-1-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(6591,0)"><use data-c="5D" xlink:href="#MJX-1-TEX-N-5D"></use></g><g data-mml-node="mo" transform="translate(7091.2,0)"><use data-c="2B" xlink:href="#MJX-1-TEX-N-2B"></use></g><g data-mml-node="mo" transform="translate(8091.4,0)"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(8480.4,0)"><use data-c="31" xlink:href="#MJX-1-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(9202.7,0)"><use data-c="2212" xlink:href="#MJX-1-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(10202.9,0)"><use data-c="1D458" xlink:href="#MJX-1-TEX-I-1D458"></use></g><g data-mml-node="mo" transform="translate(10723.9,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g><g data-mml-node="mi" transform="translate(11112.9,0)"><use data-c="1D465" xlink:href="#MJX-1-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(11684.9,0)"><use data-c="5B" xlink:href="#MJX-1-TEX-N-5B"></use></g><g data-mml-node="mi" transform="translate(11962.9,0)"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(12562.9,0)"><use data-c="5D" xlink:href="#MJX-1-TEX-N-5D"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>y</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>=</mo><mi>k</mi><mi>y</mi><mo stretchy="false">[</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>k</mi><mo stretchy="false">)</mo><mi>x</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo></math></mjx-assistive-mml></mjx-container></p>
<p><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -2.194ex;" xmlns="http://www.w3.org/2000/svg" width="28.349ex" height="5.498ex" role="img" focusable="false" viewBox="0 -1460 12530.2 2429.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-2-TEX-I-1D44C" d="M66 637Q54 637 49 637T39 638T32 641T30 647T33 664T42 682Q44 683 56 683Q104 680 165 680Q288 680 306 683H316Q322 677 322 674T320 656Q316 643 310 637H298Q242 637 242 624Q242 619 292 477T343 333L346 336Q350 340 358 349T379 373T411 410T454 461Q546 568 561 587T577 618Q577 634 545 637Q528 637 528 647Q528 649 530 661Q533 676 535 679T549 683Q551 683 578 682T657 680Q684 680 713 681T746 682Q763 682 763 673Q763 669 760 657T755 643Q753 637 734 637Q662 632 617 587Q608 578 477 424L348 273L322 169Q295 62 295 57Q295 46 363 46Q379 46 384 45T390 35Q390 33 388 23Q384 6 382 4T366 1Q361 1 324 1T232 2Q170 2 138 2T102 1Q84 1 84 9Q84 14 87 24Q88 27 89 30T90 35T91 39T93 42T96 44T101 45T107 45T116 46T129 46Q168 47 180 50T198 63Q201 68 227 171L252 274L129 623Q128 624 127 625T125 627T122 629T118 631T113 633T105 634T96 635T83 636T66 637Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-2-TEX-I-1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path><path id="MJX-2-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-2-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-2-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-2-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-2-TEX-S4-2223" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path><path id="MJX-2-TEX-I-1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path><path id="MJX-2-TEX-I-1D714" d="M495 384Q495 406 514 424T555 443Q574 443 589 425T604 364Q604 334 592 278T555 155T483 38T377 -11Q297 -11 267 66Q266 68 260 61Q201 -11 125 -11Q15 -11 15 139Q15 230 56 325T123 434Q135 441 147 436Q160 429 160 418Q160 406 140 379T94 306T62 208Q61 202 61 187Q61 124 85 100T143 76Q201 76 245 129L253 137V156Q258 297 317 297Q348 297 348 261Q348 243 338 213T318 158L308 135Q309 133 310 129T318 115T334 97T358 83T393 76Q456 76 501 148T546 274Q546 305 533 325T508 357T495 384Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(264.5,710)"><g data-mml-node="mi"><use data-c="1D44C" xlink:href="#MJX-2-TEX-I-1D44C"></use></g><g data-mml-node="mo" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152,0)"><use data-c="1D467" xlink:href="#MJX-2-TEX-I-1D467"></use></g><g data-mml-node="mo" transform="translate(1617,0)"><use data-c="29" xlink:href="#MJX-2-TEX-N-29"></use></g></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="mi"><use data-c="1D44B" xlink:href="#MJX-2-TEX-I-1D44B"></use></g><g data-mml-node="mo" transform="translate(852,0)"><use data-c="28" xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1241,0)"><use data-c="1D467" xlink:href="#MJX-2-TEX-I-1D467"></use></g><g data-mml-node="mo" transform="translate(1706,0)"><use data-c="29" xlink:href="#MJX-2-TEX-N-29"></use></g></g><rect width="2295" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(2812.8,0)"><use data-c="3D" xlink:href="#MJX-2-TEX-N-3D"></use></g><g data-mml-node="mfrac" transform="translate(3868.6,0)"><g data-mml-node="mi" transform="translate(3057.3,676)"><use data-c="1D458" xlink:href="#MJX-2-TEX-I-1D458"></use></g><g data-mml-node="mrow" transform="translate(220,-719.9)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-2-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(722.2,0)"><use data-c="2212" xlink:href="#MJX-2-TEX-N-2212"></use></g><g data-mml-node="mo" transform="translate(1722.4,0)"><use data-c="28" xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(2111.4,0)"><use data-c="31" xlink:href="#MJX-2-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(2833.7,0)"><use data-c="2212" xlink:href="#MJX-2-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(3833.9,0)"><use data-c="1D458" xlink:href="#MJX-2-TEX-I-1D458"></use></g><g data-mml-node="mo" transform="translate(4354.9,0)"><use data-c="29" xlink:href="#MJX-2-TEX-N-29"></use></g><g data-mml-node="msup" transform="translate(4743.9,0)"><g data-mml-node="mi"><use data-c="1D467" xlink:href="#MJX-2-TEX-I-1D467"></use></g><g data-mml-node="TeXAtom" transform="translate(498,289) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-2-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="31" xlink:href="#MJX-2-TEX-N-31"></use></g></g></g></g><rect width="6395.6" height="60" x="120" y="220"></rect></g><g data-mml-node="msub" transform="translate(10504.1,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mo"><svg width="278" height="2047" y="-773.5" x="27.5" viewBox="0 -253.6 278 2047"><use data-c="2223" xlink:href="#MJX-2-TEX-S4-2223" transform="scale(1,3.074)"></use></svg></g></g><g data-mml-node="TeXAtom" transform="translate(366,-808.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D467" xlink:href="#MJX-2-TEX-I-1D467"></use></g><g data-mml-node="mo" transform="translate(465,0)"><use data-c="3D" xlink:href="#MJX-2-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(1243,0)"><use data-c="1D457" xlink:href="#MJX-2-TEX-I-1D457"></use></g><g data-mml-node="mi" transform="translate(1655,0)"><use data-c="1D714" xlink:href="#MJX-2-TEX-I-1D714"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mfrac><mrow><mi>Y</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><mrow><mi>X</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mfrac><mi>k</mi><mrow><mn>1</mn><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>k</mi><mo stretchy="false">)</mo><msup><mi>z</mi><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><msub><mrow data-mjx-texclass="ORD"><mo minsize="2.047em" maxsize="2.047em">|</mo></mrow><mrow data-mjx-texclass="ORD"><mi>z</mi><mo>=</mo><mi>j</mi><mi>ω</mi></mrow></msub></math></mjx-assistive-mml></mjx-container></p>
<p>I’ve plotted the frequency response of the filter (which isn’t amazing, but it runs pretty fast seeing as it’s single pole).</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-14.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-14. Frequency response of single pole IIR LPF, k=0.1,0.2,0.3"><figcaption class="figure-caption text-center" align="center">Fig. 13-14. Frequency response of single pole IIR LPF, k=0.1,0.2,0.3</figcaption></figure></div></p>
<p><em>IIR filter implementation within atan2 conversion</em></p>
<pre class="language-cpp"><code class="language-cpp">
accel_pitch <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span>accel_x<span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>accel_z<span class="token operator">*</span>accel_z <span class="token operator">+</span> accel_y<span class="token operator">*</span>accel_y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">180.0f</span><span class="token operator">/</span><span class="token number">3.1415963f</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01f</span> <span class="token operator">+</span> <span class="token number">0.99f</span><span class="token operator">*</span>accel_pitch<span class="token punctuation">;</span>
accel_roll <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span>accel_y<span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>accel_z<span class="token operator">*</span>accel_z <span class="token operator">+</span> accel_x<span class="token operator">*</span>accel_x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">180.0f</span><span class="token operator">/</span><span class="token number">3.1415963f</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01f</span> <span class="token operator">+</span> <span class="token number">0.99f</span><span class="token operator">*</span>accel_roll<span class="token punctuation">;</span>
</code></pre>
<p>I also created the conversion code from accelerometer g readings to estimated pitch and roll using the arctan function. The gravity vector is sensed by taking the dot product of the gravity vector and the axes of the accelerometer, giving 3 acceleration values. Assuming no other acceleration is present (haha like that’ll happen), the arctan function can be used to find the angle of the vector formed by the axes readings.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-15.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-16. How the gravity vector is applied across the axes of the accelerometer"><figcaption class="figure-caption text-center" align="center">Fig. 13-16. How the gravity vector is applied across the axes of the accelerometer</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-16.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-17. Pitch and roll after IIR and Atan2 computation"><figcaption class="figure-caption text-center" align="center">Fig. 13-17. Pitch and roll after IIR and Atan2 computation</figcaption></figure></div></p>
<p>Lastly I implemented a filter called the complementary filter, which combines the high frequency gyroscope readings (which are reliable in the short term), and the noisy but long-term stable accelerometer angle, to compute a simple estimate of the true angle. It isn’t amazing, and all these fusion steps need more work, but it’s a start, and indicates the sensors are providing reliable data.</p>
<p><em>Complementary filter implementation</em></p>
<pre class="language-cpp"><code class="language-cpp">compl_pitch <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token operator">-</span>ALPHA<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span>gyro_rate_y<span class="token operator">*</span><span class="token number">2.0f</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>current_time <span class="token operator">-</span> last_time<span class="token punctuation">)</span> <span class="token operator">+</span> ALPHA <span class="token operator">*</span> <span class="token punctuation">(</span>accel_pitch<span class="token operator">-</span>compl_pitch<span class="token punctuation">)</span><span class="token punctuation">;</span>
compl_roll <span class="token operator">+=</span>  <span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token operator">-</span>ALPHA<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>gyro_rate_x<span class="token operator">*</span><span class="token number">2.0f</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>current_time <span class="token operator">-</span> last_time<span class="token punctuation">)</span> <span class="token operator">+</span> ALPHA <span class="token operator">*</span> <span class="token punctuation">(</span>accel_roll<span class="token operator">-</span>compl_roll<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-17.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-19. Angle estimation using complementary filter, demonstrates no drift, and good noise tolerance"><figcaption class="figure-caption text-center" align="center">Fig. 13-19. Angle estimation using complementary filter, demonstrates no drift, and good noise tolerance</figcaption></figure></div></p>

            </div>
            
        </div>
    </div>

    <div class="container-md d-none d-print-block">
        <div class="row justify-content-center">
            
            <div class="col mr-auto ml-auto">
                 <h1>Week 13</h1>
<p><strong>PCB</strong></p>
<p>After last week’s less than excellent progress after bricking a chip trying to get the IMU working, I decided to use the hot plate and reflow the entire top of the PCB in one shot. (Unfortunately, I didn’t get pictures of the stencil and reflow process, I was a little rushed) I started by organizing all the parts on a printout I developed last week to help place the parts with the right values in the right spots. I also ordered a bunch of 0.1uF 0603 caps, and 0603 LEDs so I wouldn’t have to ‘borrow’ some from some of my other boards.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-1. Parts layout before placement"><figcaption class="figure-caption text-center" align="center">Fig. 13-1. Parts layout before placement</figcaption></figure></div></p>
<p>With this all ready, I got the stencil ready for use. The stencil we purchased with our board came as a very large thin sheet of metal, with the small cutouts for our board in the center. This was way to large to use as is, so I used the metal sheet cutter to cut it down to size first. With the stencil ready, I set up the board to be stenciled by using a metal right-angle of equal thickness to the PCB to secure the PCB on the table, and then taped the stencil down onto the PCB like a hinge, ensuring each little slot lined up with the correct pad.</p>
<p>Then Joe prepared the solder paste, waiting for it to get slightly warmer than the refrigerator it is stored in, and then we applied it to the stencil by scraping it across with a credit card-like tool. After a couple tries, we got the right amount of solder applied without it smearing around the pads and shorting nearby pads.</p>
<p>Then I took the PCB with paste back to my station, and carefully placed each part onto it’s pads with tweezers, carefully aligning and double-checking them. Once I was confident the placement was correct and aligned, Joe helped me use the (very hot) hot plate to preheat my PCB, and then reflow the paste on the PCB. It was very cool to see the paste boil, the solder melt, and all the components float into place as the solder glistens. After the PCB cooled down, I washed it off and took a look at the results.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-1.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-2. PCB after reflow, note shorts on multiple parts"><figcaption class="figure-caption text-center" align="center">Fig. 13-2. PCB after reflow, note shorts on multiple parts</figcaption></figure></div></p>
<p>Nearly all the components were soldered correctly, but both IMUs, the micro, and the USB connector had shorts due to excess solder paste. The IMU joints were easy to clear, but the micro was surprisingly difficult. Joe had to help me clear them, but afterwards it looked quite nice. The USB was the most frustrating, as it had bridged ID and ground, and VUSB and ground. Anything shorted to ground on the USB connector is difficult to fix, as the USB connector sucks all the heat away as the iron tries to melt the joints. ID I left shorted, as the board doesn’t use it and the bus doesn’t care, but I was able to successfully clear the bridge with VUSB with lots of heat and flux.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-2.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-3. PCB after shorts fixed."><figcaption class="figure-caption text-center" align="center">Fig. 13-3. PCB after shorts fixed.</figcaption></figure></div></p>
<p>Once the top of the PCB was complete, I went back and hand-soldered each cap onto the back of the PCB. This was pretty easy after doing the first board thankfully. After adding the 3.3V regulator, the board was ready to test.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-3.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-4. Back side of PCB after hand-soldering all caps and regulator."><figcaption class="figure-caption text-center" align="center">Fig. 13-4. Back side of PCB after hand-soldering all caps and regulator.</figcaption></figure></div></p>
<p>Testing simply consisted of lots of continuity checks (and checks for shorts), and powering the board from the 3.3V supply on the programmer. With LEDs coming on properly, I programmed the board successfully with a ‘blink LED’ test program and then proceeded to test the USB-serial as well. Surprisingly, all hardware, even the IMU, worked first try. Good stuff.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-4.png" class="figure-img img-fluid rounded" alt="alt text" title=" "><figcaption class="figure-caption text-center" align="center"> </figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-5.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-5. Power-up and testing of USB->Serial"><figcaption class="figure-caption text-center" align="center">Fig. 13-5. Power-up and testing of USB-&gt;Serial</figcaption></figure></div></p>
<p><strong>Mechanical</strong></p>
<p>Jon got the mounting bracket for the flight controller printed this week, so I tried to get it mounted, and see if it needed any changes and a reprint. After removing the raft and support material, and cleaning off the thin wisps of print material, the bracket was looking good.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-6.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-6. Flight controller mounting bracket after printing"><figcaption class="figure-caption text-center" align="center">Fig. 13-6. Flight controller mounting bracket after printing</figcaption></figure></div></p>
<p>An initial evaluation revealed however that I had forgotten a couple very important components when designing this, the motor cables and the motor controller clearance. As can be seen in Fig. 7, the bracket doesn’t leave any space between the screw holes for the motor cables to pass under, as well as coming real close to the top of the motor controller.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-7.png" class="figure-img img-fluid rounded" alt="alt text" title=" "><figcaption class="figure-caption text-center" align="center"> </figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-8.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-7. Clearance and cable issues with flight controller mount"><figcaption class="figure-caption text-center" align="center">Fig. 13-7. Clearance and cable issues with flight controller mount</figcaption></figure></div></p>
<p>These issues didn’t seem to be solvable without damaging the mount, or modification of the motor cable routing (which I definitely didn’t want to change), so I decided to make some modifications and reprint.</p>
<p>I fixed both issues by extruding the part of the bracket that surrounds the mounting screws, but leaving space for the motor cables – this increased the clearance while making space for the wires, solving (I hope) both issues.</p>
<p>I’ve sent this print to Jon, so he’ll hopefully have this printed soon so we can get flying.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-9.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-8. Edited bracket after changes"><figcaption class="figure-caption text-center" align="center">Fig. 13-8. Edited bracket after changes</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-10.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-9. Fixed bracket in place within assembly"><figcaption class="figure-caption text-center" align="center">Fig. 13-9. Fixed bracket in place within assembly</figcaption></figure></div></p>
<p><strong>Clock Tree</strong></p>
<p>With the hardware on the board working, I decided it was the right time to fix an issue I’d been ignoring and waiting to fix, namely the clock speed. The STM32F446 can run up to 180MHz, which is much of why we chose it over other STM32F4 options. However the default clock settings at startup use the HSI (High Speed Internal) RC oscillator, without PLL, which runs the chip at a relatively sluggish 16MHz. The PCB was designed with the use of an external 16MHz crystal oscillator for higher precision, but also use of the internal PLLs and multipliers available to run the system clock at 180MHZ, and the peripheral clocks at their max speed.</p>
<p>So this week I spent multiple hours changing the clock and PLL settings to select (for now) the HSI, but to direct it through the PLLs available to multiply the clock rate up to 180MHz. To help with this, I used the CubeMX editor to play with clock tree values, and then when I was confident they were right, I edited the PLL and clock setup code to reflect those choices. Once this was working, I had to go through each peripheral and determine if it was running at the speed I thought it was, and edit #defines to properly calculate their clock speed off of the PLLs and divisor settings I selected.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-11.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-10. PLL and divisor settings used on the Micro"><figcaption class="figure-caption text-center" align="center">Fig. 13-10. PLL and divisor settings used on the Micro</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-12.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13- 11. Verifying that SPI CLK signal runs at the expected 90MHz / 256 = 352.6KHz during testing"><figcaption class="figure-caption text-center" align="center">Fig. 13- 11. Verifying that SPI CLK signal runs at the expected 90MHz / 256 = 352.6KHz during testing</figcaption></figure></div></p>
<p><strong>Motors &amp; Radio</strong></p>
<p>This week I also fixed multiple bugs in the motor code such that the max throttle range is used, and with the highest possible fidelity. I had an issue where I was using a range from 0-100,000, and then storing that un a uint16 -&gt; resulting in overflow and rollover. This caused a dangerous situation where the motors would ramp from full speed to stopped instantly, causing a huge current draw and heating up the motors and the ESC.</p>
<div id="4aSOW4n8nL4" class="eleventy-plugin-youtube-embed" style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/4aSOW4n8nL4" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p><strong>IMU</strong></p>
<p>Lastly, I put quite a bit of time into calibrating and adapting the IMU software to filter and combine the accelerometer and gyroscope. The gyro, after fixing some timing issues, worked on the PCB just as it had before on the dev board, with the gyro raw rate being properly converted into degrees per second. Most of all, I increased the SPI bus speed from a divisor=256 from the APB2 peripheral clock (90MHz down to 351kHz) to a divisor=32 (90MHz down to 2.8MHz).
For the accelerometer, I had to write a similar calibration sequence to the gyroscope, except that the accelerometer has one axis with a constant bias from gravity, so that has to be removed prior to the calibration phase, so that the calibration value doesn’t roll over as it gets summed up. I also converted the raw values (-32768 to 32767) to a floating point, where 1.0f maps to +1G (9.81 m/s^2).</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-18.png" class="figure-img img-fluid rounded" alt="alt text" title="Signal processing chain block diagram"><figcaption class="figure-caption text-center" align="center">Signal processing chain block diagram</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-19.png" class="figure-img img-fluid rounded" alt="alt text" title="IMU to motor output data flow"><figcaption class="figure-caption text-center" align="center">IMU to motor output data flow</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-13.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-13. Normalized accelerometer data"><figcaption class="figure-caption text-center" align="center">Fig. 13-13. Normalized accelerometer data</figcaption></figure></div></p>
<p>I also created a very simple IIR filter for the accelerometer data, single pole:</p>
<p><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="29.052ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 12840.9 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-3-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-3-TEX-N-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path><path id="MJX-3-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-3-TEX-N-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path><path id="MJX-3-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-3-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-3-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-3-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-3-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-3-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-3-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-3-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D466" xlink:href="#MJX-3-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(490,0)"><use data-c="5B" xlink:href="#MJX-3-TEX-N-5B"></use></g><g data-mml-node="mi" transform="translate(768,0)"><use data-c="1D45B" xlink:href="#MJX-3-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(1368,0)"><use data-c="5D" xlink:href="#MJX-3-TEX-N-5D"></use></g><g data-mml-node="mo" transform="translate(1923.8,0)"><use data-c="3D" xlink:href="#MJX-3-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(2979.6,0)"><use data-c="1D458" xlink:href="#MJX-3-TEX-I-1D458"></use></g><g data-mml-node="mi" transform="translate(3500.6,0)"><use data-c="1D466" xlink:href="#MJX-3-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(3990.6,0)"><use data-c="5B" xlink:href="#MJX-3-TEX-N-5B"></use></g><g data-mml-node="mi" transform="translate(4268.6,0)"><use data-c="1D45B" xlink:href="#MJX-3-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(5090.8,0)"><use data-c="2212" xlink:href="#MJX-3-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(6091,0)"><use data-c="31" xlink:href="#MJX-3-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(6591,0)"><use data-c="5D" xlink:href="#MJX-3-TEX-N-5D"></use></g><g data-mml-node="mo" transform="translate(7091.2,0)"><use data-c="2B" xlink:href="#MJX-3-TEX-N-2B"></use></g><g data-mml-node="mo" transform="translate(8091.4,0)"><use data-c="28" xlink:href="#MJX-3-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(8480.4,0)"><use data-c="31" xlink:href="#MJX-3-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(9202.7,0)"><use data-c="2212" xlink:href="#MJX-3-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(10202.9,0)"><use data-c="1D458" xlink:href="#MJX-3-TEX-I-1D458"></use></g><g data-mml-node="mo" transform="translate(10723.9,0)"><use data-c="29" xlink:href="#MJX-3-TEX-N-29"></use></g><g data-mml-node="mi" transform="translate(11112.9,0)"><use data-c="1D465" xlink:href="#MJX-3-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(11684.9,0)"><use data-c="5B" xlink:href="#MJX-3-TEX-N-5B"></use></g><g data-mml-node="mi" transform="translate(11962.9,0)"><use data-c="1D45B" xlink:href="#MJX-3-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(12562.9,0)"><use data-c="5D" xlink:href="#MJX-3-TEX-N-5D"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>y</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>=</mo><mi>k</mi><mi>y</mi><mo stretchy="false">[</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>k</mi><mo stretchy="false">)</mo><mi>x</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo></math></mjx-assistive-mml></mjx-container></p>
<p><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -2.194ex;" xmlns="http://www.w3.org/2000/svg" width="28.349ex" height="5.498ex" role="img" focusable="false" viewBox="0 -1460 12530.2 2429.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-4-TEX-I-1D44C" d="M66 637Q54 637 49 637T39 638T32 641T30 647T33 664T42 682Q44 683 56 683Q104 680 165 680Q288 680 306 683H316Q322 677 322 674T320 656Q316 643 310 637H298Q242 637 242 624Q242 619 292 477T343 333L346 336Q350 340 358 349T379 373T411 410T454 461Q546 568 561 587T577 618Q577 634 545 637Q528 637 528 647Q528 649 530 661Q533 676 535 679T549 683Q551 683 578 682T657 680Q684 680 713 681T746 682Q763 682 763 673Q763 669 760 657T755 643Q753 637 734 637Q662 632 617 587Q608 578 477 424L348 273L322 169Q295 62 295 57Q295 46 363 46Q379 46 384 45T390 35Q390 33 388 23Q384 6 382 4T366 1Q361 1 324 1T232 2Q170 2 138 2T102 1Q84 1 84 9Q84 14 87 24Q88 27 89 30T90 35T91 39T93 42T96 44T101 45T107 45T116 46T129 46Q168 47 180 50T198 63Q201 68 227 171L252 274L129 623Q128 624 127 625T125 627T122 629T118 631T113 633T105 634T96 635T83 636T66 637Z"></path><path id="MJX-4-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-4-TEX-I-1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path><path id="MJX-4-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-4-TEX-I-1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path><path id="MJX-4-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-4-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-4-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-4-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-4-TEX-S4-2223" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path><path id="MJX-4-TEX-I-1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path><path id="MJX-4-TEX-I-1D714" d="M495 384Q495 406 514 424T555 443Q574 443 589 425T604 364Q604 334 592 278T555 155T483 38T377 -11Q297 -11 267 66Q266 68 260 61Q201 -11 125 -11Q15 -11 15 139Q15 230 56 325T123 434Q135 441 147 436Q160 429 160 418Q160 406 140 379T94 306T62 208Q61 202 61 187Q61 124 85 100T143 76Q201 76 245 129L253 137V156Q258 297 317 297Q348 297 348 261Q348 243 338 213T318 158L308 135Q309 133 310 129T318 115T334 97T358 83T393 76Q456 76 501 148T546 274Q546 305 533 325T508 357T495 384Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(264.5,710)"><g data-mml-node="mi"><use data-c="1D44C" xlink:href="#MJX-4-TEX-I-1D44C"></use></g><g data-mml-node="mo" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-4-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152,0)"><use data-c="1D467" xlink:href="#MJX-4-TEX-I-1D467"></use></g><g data-mml-node="mo" transform="translate(1617,0)"><use data-c="29" xlink:href="#MJX-4-TEX-N-29"></use></g></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="mi"><use data-c="1D44B" xlink:href="#MJX-4-TEX-I-1D44B"></use></g><g data-mml-node="mo" transform="translate(852,0)"><use data-c="28" xlink:href="#MJX-4-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1241,0)"><use data-c="1D467" xlink:href="#MJX-4-TEX-I-1D467"></use></g><g data-mml-node="mo" transform="translate(1706,0)"><use data-c="29" xlink:href="#MJX-4-TEX-N-29"></use></g></g><rect width="2295" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(2812.8,0)"><use data-c="3D" xlink:href="#MJX-4-TEX-N-3D"></use></g><g data-mml-node="mfrac" transform="translate(3868.6,0)"><g data-mml-node="mi" transform="translate(3057.3,676)"><use data-c="1D458" xlink:href="#MJX-4-TEX-I-1D458"></use></g><g data-mml-node="mrow" transform="translate(220,-719.9)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-4-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(722.2,0)"><use data-c="2212" xlink:href="#MJX-4-TEX-N-2212"></use></g><g data-mml-node="mo" transform="translate(1722.4,0)"><use data-c="28" xlink:href="#MJX-4-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(2111.4,0)"><use data-c="31" xlink:href="#MJX-4-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(2833.7,0)"><use data-c="2212" xlink:href="#MJX-4-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(3833.9,0)"><use data-c="1D458" xlink:href="#MJX-4-TEX-I-1D458"></use></g><g data-mml-node="mo" transform="translate(4354.9,0)"><use data-c="29" xlink:href="#MJX-4-TEX-N-29"></use></g><g data-mml-node="msup" transform="translate(4743.9,0)"><g data-mml-node="mi"><use data-c="1D467" xlink:href="#MJX-4-TEX-I-1D467"></use></g><g data-mml-node="TeXAtom" transform="translate(498,289) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-4-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="31" xlink:href="#MJX-4-TEX-N-31"></use></g></g></g></g><rect width="6395.6" height="60" x="120" y="220"></rect></g><g data-mml-node="msub" transform="translate(10504.1,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mo"><svg width="278" height="2047" y="-773.5" x="27.5" viewBox="0 -253.6 278 2047"><use data-c="2223" xlink:href="#MJX-4-TEX-S4-2223" transform="scale(1,3.074)"></use></svg></g></g><g data-mml-node="TeXAtom" transform="translate(366,-808.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D467" xlink:href="#MJX-4-TEX-I-1D467"></use></g><g data-mml-node="mo" transform="translate(465,0)"><use data-c="3D" xlink:href="#MJX-4-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(1243,0)"><use data-c="1D457" xlink:href="#MJX-4-TEX-I-1D457"></use></g><g data-mml-node="mi" transform="translate(1655,0)"><use data-c="1D714" xlink:href="#MJX-4-TEX-I-1D714"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mfrac><mrow><mi>Y</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><mrow><mi>X</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mfrac><mi>k</mi><mrow><mn>1</mn><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>k</mi><mo stretchy="false">)</mo><msup><mi>z</mi><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><msub><mrow data-mjx-texclass="ORD"><mo minsize="2.047em" maxsize="2.047em">|</mo></mrow><mrow data-mjx-texclass="ORD"><mi>z</mi><mo>=</mo><mi>j</mi><mi>ω</mi></mrow></msub></math></mjx-assistive-mml></mjx-container></p>
<p>I’ve plotted the frequency response of the filter (which isn’t amazing, but it runs pretty fast seeing as it’s single pole).</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-14.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-14. Frequency response of single pole IIR LPF, k=0.1,0.2,0.3"><figcaption class="figure-caption text-center" align="center">Fig. 13-14. Frequency response of single pole IIR LPF, k=0.1,0.2,0.3</figcaption></figure></div></p>
<p><em>IIR filter implementation within atan2 conversion</em></p>
<pre class="language-cpp"><code class="language-cpp">
accel_pitch <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span>accel_x<span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>accel_z<span class="token operator">*</span>accel_z <span class="token operator">+</span> accel_y<span class="token operator">*</span>accel_y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">180.0f</span><span class="token operator">/</span><span class="token number">3.1415963f</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01f</span> <span class="token operator">+</span> <span class="token number">0.99f</span><span class="token operator">*</span>accel_pitch<span class="token punctuation">;</span>
accel_roll <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span>accel_y<span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>accel_z<span class="token operator">*</span>accel_z <span class="token operator">+</span> accel_x<span class="token operator">*</span>accel_x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">180.0f</span><span class="token operator">/</span><span class="token number">3.1415963f</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01f</span> <span class="token operator">+</span> <span class="token number">0.99f</span><span class="token operator">*</span>accel_roll<span class="token punctuation">;</span>
</code></pre>
<p>I also created the conversion code from accelerometer g readings to estimated pitch and roll using the arctan function. The gravity vector is sensed by taking the dot product of the gravity vector and the axes of the accelerometer, giving 3 acceleration values. Assuming no other acceleration is present (haha like that’ll happen), the arctan function can be used to find the angle of the vector formed by the axes readings.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-15.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-16. How the gravity vector is applied across the axes of the accelerometer"><figcaption class="figure-caption text-center" align="center">Fig. 13-16. How the gravity vector is applied across the axes of the accelerometer</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-16.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-17. Pitch and roll after IIR and Atan2 computation"><figcaption class="figure-caption text-center" align="center">Fig. 13-17. Pitch and roll after IIR and Atan2 computation</figcaption></figure></div></p>
<p>Lastly I implemented a filter called the complementary filter, which combines the high frequency gyroscope readings (which are reliable in the short term), and the noisy but long-term stable accelerometer angle, to compute a simple estimate of the true angle. It isn’t amazing, and all these fusion steps need more work, but it’s a start, and indicates the sensors are providing reliable data.</p>
<p><em>Complementary filter implementation</em></p>
<pre class="language-cpp"><code class="language-cpp">compl_pitch <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token operator">-</span>ALPHA<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span>gyro_rate_y<span class="token operator">*</span><span class="token number">2.0f</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>current_time <span class="token operator">-</span> last_time<span class="token punctuation">)</span> <span class="token operator">+</span> ALPHA <span class="token operator">*</span> <span class="token punctuation">(</span>accel_pitch<span class="token operator">-</span>compl_pitch<span class="token punctuation">)</span><span class="token punctuation">;</span>
compl_roll <span class="token operator">+=</span>  <span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token operator">-</span>ALPHA<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>gyro_rate_x<span class="token operator">*</span><span class="token number">2.0f</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>current_time <span class="token operator">-</span> last_time<span class="token punctuation">)</span> <span class="token operator">+</span> ALPHA <span class="token operator">*</span> <span class="token punctuation">(</span>accel_roll<span class="token operator">-</span>compl_roll<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-17.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 13-19. Angle estimation using complementary filter, demonstrates no drift, and good noise tolerance"><figcaption class="figure-caption text-center" align="center">Fig. 13-19. Angle estimation using complementary filter, demonstrates no drift, and good noise tolerance</figcaption></figure></div></p>

            </div>
            
        </div>
    </div>

<!--<div class="b-example-divider"></div>-->

<div class="container d-print-none">
  <footer class="flex-wrap border-top">
      <p class="text-center text-muted">© 2023 Michael Langford. Built with 11ty.</p>
  </footer>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  <script src="/assets/js/index.js"></script>
  <script data-goatcounter="https://michaellangford99.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>
  </body>
</html>
