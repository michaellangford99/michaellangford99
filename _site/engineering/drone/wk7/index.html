
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="google-site-verification" content="jWYz4n1G8T7OHT4uWrEfZc6Qx-KFsPUYCC6oLXvfJHs">

    <!-- Bootstrap CSS -->
   <title>ECE477 Drone - Week 7</title> 
   
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!---<link rel="stylesheet" href="/assets/css/prism-vsc-dark-plus.css"/>  -->
    <!---<link href="https://unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet"> -->
   <!--- <link rel="stylesheet" href="/assets/css/prism-vs.css"/>    -->
   <link rel="stylesheet" href="/assets/css/prism-vsc-dark-plus.css">
    <link rel="stylesheet" href="/assets/css/clean-blog.css">
    
  </head>
  <body>


<nav class="navbar navbar-expand-lg bg-body-tertiary bg-dark border-bottom border-bottom-dark d-print-none" data-bs-theme="dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Michaelangelo</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">

    
    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
      <li class="nav-item">
        <a class="nav-link" href="/hiking/">Hiking &amp; Photography</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/engineering/">Engineering</a>
      </li>
    </ul>

<!--
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="#">Home</a>
        </li>

        <li class="nav-item"><a class="nav-link" href="#">Hiking & Photograpy</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Engineering</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Computer Graphics</a></li>       
        <li class="nav-item"><a class="nav-link" href="#">Thoughts</a></li>
        
        
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Dropdown
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">Action</a></li>
            <li><a class="dropdown-item" href="#">Another action</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">Something else here</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled">Disabled</a>
        </li>


      </ul>
-->

      <!--<form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Search</button>
      </form>-->
    </div>
  </div>
</nav>
    
<div class="bg-image p-5 text-center shadow-1-strong mb-2 text-white d-print-none" style="background-image: url('/assets/images/crestone.jpg'); background-position: center; background-size:cover;">
<div style="padding: 100px 0 130px ">
  <h1 class="mb-2 h1">ECE477 Drone - Week 7</h1>
  <p>
    
  </p>
</div>
</div>

<!--<div class="container-md">
  <div class="alert alert-primary" role="alert">
    This was going to be the nav bar but now I might get rid of this lol.
  </div>
</div>-->

    <div class="container-md d-print-none">
        <div class="row justify-content-center">
            
            <div class="col-md-9 mr-auto ml-auto">
                 <h1>Week 7</h1>
<p><strong>PCB Design</strong></p>
<p>This week was mostly spent finishing the schematic and PCB layout for the flight controller. Both had reached a good point last week, and so the remaining efforts were implementing the IMU recommended designs, touching up the PCB component positions, silkscreen references, routing power traces, and cleaning up traces and ground planes to maximize signal integrity and current capacity, and minimize voltage drop and noise.</p>
<p>Again, I won’t show how the sausage is made too much, as it is a very, very iterative process and stuff keeps moving around on the PCB until I am satisfied with its position.</p>
<p>However, as things move around, the optimal location to have the signal pins originate off the microcontroller can change. So, in addition to selecting optimal final locations for the components, I frequently checked the datasheet, and a handy ST tool to check which UARTs, SPI busses, etc. could be enabled on which IO pins.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image.png" class="figure-img img-fluid rounded" alt="Alt text" title="STM32F446 pin mappings"><figcaption class="figure-caption text-center" align="center">STM32F446 pin mappings</figcaption></figure></div></p>
<p>Using this tool, I could validate that my pin configuration was workable with my physical layout, and then implement that on my schematic.</p>
<p>Implementing the IMU was mildly interesting, as I want the capability to use either the MPU9250, the LSM6DS3, or both. So in addition to adding the recommended parts, caps, etc., I added a network of 0 ohm resistor switches to enable the desired configuration as needed.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-1.png" class="figure-img img-fluid rounded" alt="Alt text" title="Dual IMU configuration"><figcaption class="figure-caption text-center" align="center">Dual IMU configuration</figcaption></figure></div></p>
<p>I also added the PI Zero connector that I had put off for last, selecting a part of the Pi header to interface to that contains the UART, +5V, and ground. This is pins 1 through 10 at the far edge of the PI PCB. This ended up being a relatively convenient spot after I moved a couple things out of its way.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-2.png" class="figure-img img-fluid rounded" alt="Alt text" title="Pi Zero pinout"><figcaption class="figure-caption text-center" align="center">Pi Zero pinout</figcaption></figure></div></p>
<p>Now that the part was in the ~mostly correct spot, I had to ensure that the connector would line up perfectly by looking up the exact dimensions of the board, and by verifying the setup by printing a to-scale version of the board and checking it against the Pi Zero I own.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-3.png" class="figure-img img-fluid rounded" alt="Alt text" title="Pi Zero dimensions"><figcaption class="figure-caption text-center" align="center">Pi Zero dimensions</figcaption></figure></div></p>
<p>Using these measurements, I worked to place it in what I believed was the best position. Then I printed off the too scale version and compared. I noticed that while all the corner holes were properly aligned, the connector was about a millimeter too far to the right. I then readjusted and printed again. Much better! A visual check shows the pins at the exact right spot.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-4.png" class="figure-img img-fluid rounded" alt="Alt text" title="PCB drill and borders plot"><figcaption class="figure-caption text-center" align="center">PCB drill and borders plot</figcaption></figure></div></p>
<p><img src="image-5.png" alt="Alt text"></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-6.png" class="figure-img img-fluid rounded" alt="Alt text" title="PCB size comparison"><figcaption class="figure-caption text-center" align="center">PCB size comparison</figcaption></figure></div></p>
<p>After much additional moving and redrawing, I got the board to a physically and electrically satisfactory point, with correct footprint positions, trace widths, silkscreen, etc.</p>
<p>The result looks like this.</p>
<p><img src="image-7.png" alt="Alt text"></p>
<p><img src="image-8.png" alt="Alt text"></p>
<p><img src="image-9.png" alt="Alt text"></p>
<p><img src="image-10.png" alt="Alt text"></p>
<p><strong>Radio Code</strong></p>
<p>I also revisited my radio CRSF interpretation code this week, in order to improve my relatively hacky code – which worked but performed almost no data validation (dangerous!), and was very inefficient.</p>
<p>For the new design, I chose a circular buffer, where the ‘start’ of the buffer would be shifted up until the end of the buffer, and then back around, rather than shifting the buffer contents while looking for a valid packet. This is significantly more efficient. Once it sees a valid starting character, it places a struct pointer at that location in memory, and begins to decode the data from that position, pulling out descriptors like the frame length from the point indicated my the struct definition. If needed, the ‘rolled over’ part of memory in the circular buffer is copied over to free space at the end of the buffer so the data frame is contiguous. Then the address, frame type, and CRC are checked. If these are valid, then the channel data is copied over to the global location for the latest radio channel data.</p>
<p>This system actually worked almost perfectly first try, which was great! I only had to fix a couple pointer casts and offsets, and the system was good to go. Another benefit is I went to the source code on the ELRS site and used their #defines and enums, so that my code is using not only the right values, but the canonical names for each field.</p>
<pre class="language-c"><code class="language-c">
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>crsf_addr_e<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>rx_buffer_start<span class="token punctuation">)</span> <span class="token operator">==</span> CRSF_ADDRESS_FLIGHT_CONTROLLER<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">//go through and attempt to parse</span>
  <span class="token comment">//place the data struct at this location and see if it passes</span>
  <span class="token comment">//first task is to verify the length is within bounds, and</span>
  <span class="token comment">//that the message type is what we're looking for</span>
  <span class="token comment">//Then verify it has a valid CRC</span>
  <span class="token comment">//move everything from the beginning of memory to</span>

  <span class="token class-name">crsf_packet_t</span><span class="token operator">*</span> crsf_packet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">crsf_packet_t</span><span class="token operator">*</span><span class="token punctuation">)</span>rx_buffer_start<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>type <span class="token operator">==</span> CRSF_FRAMETYPE_RC_CHANNELS_PACKED<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>frame_size <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">crsf_channels_t</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token comment">/*type, crc, and payload*/</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//validate CRC</span>

      <span class="token comment">//copy everything from bottom to the rx_buffer_start point into the upper half of the array to make it contiguous</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>rx_buffer <span class="token operator">+</span> BUFFER_SIZE<span class="token punctuation">,</span> rx_buffer<span class="token punctuation">,</span> rx_buffer_start<span class="token operator">-</span>rx_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">uint8_t</span> calculated_crc <span class="token operator">=</span> <span class="token function">calc_crc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">crsf_channels_t</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token comment">/*don't include the CRC in the CRC calc haha*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">uint8_t</span> rx_crc <span class="token operator">=</span> crsf_packet<span class="token operator">-&gt;</span>crc<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>rx_crc <span class="token operator">==</span> calculated_crc<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token comment">//valid packet</span>
        <span class="token comment">//TODO save the last 30 or so channel packets for filtering if needed</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>saved_channel_data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>channels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">crsf_channels_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-12.png" class="figure-img img-fluid rounded" alt="Alt text" title="Data streaming in"><figcaption class="figure-caption text-center" align="center">Data streaming in</figcaption></figure></div></p>
<pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> ch0 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch1 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch2 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch3 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch4 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch5 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch6 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch7 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch8 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch9 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch10 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch11 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch12 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch13 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch14 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch15 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">crsf_channels_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> device_addr<span class="token punctuation">;</span> <span class="token comment">// from crsf_addr_e</span>
    <span class="token class-name">uint8_t</span> frame_size<span class="token punctuation">;</span>  <span class="token comment">// counts size after this byte, so it must be the payload size + 2 (type and crc)</span>
    <span class="token class-name">uint8_t</span> type<span class="token punctuation">;</span>        <span class="token comment">// from crsf_frame_type_e</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">crsf_header_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
	<span class="token class-name">crsf_header_t</span> header<span class="token punctuation">;</span>
	<span class="token class-name">crsf_channels_t</span> channels<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span> crc<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">crsf_packet_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{</span>
    CRSF_FRAMETYPE_GPS <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_BATTERY_SENSOR <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_LINK_STATISTICS <span class="token operator">=</span> <span class="token number">0x14</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_RC_CHANNELS_PACKED <span class="token operator">=</span> <span class="token number">0x16</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_ATTITUDE <span class="token operator">=</span> <span class="token number">0x1E</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_FLIGHT_MODE <span class="token operator">=</span> <span class="token number">0x21</span><span class="token punctuation">,</span>
    <span class="token comment">// Extended Header Frames, range: 0x28 to 0x96</span>
    CRSF_FRAMETYPE_DEVICE_PING <span class="token operator">=</span> <span class="token number">0x28</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_DEVICE_INFO <span class="token operator">=</span> <span class="token number">0x29</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_PARAMETER_SETTINGS_ENTRY <span class="token operator">=</span> <span class="token number">0x2B</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_PARAMETER_READ <span class="token operator">=</span> <span class="token number">0x2C</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_PARAMETER_WRITE <span class="token operator">=</span> <span class="token number">0x2D</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_COMMAND <span class="token operator">=</span> <span class="token number">0x32</span><span class="token punctuation">,</span>
    <span class="token comment">// MSP commands</span>
    CRSF_FRAMETYPE_MSP_REQ <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">,</span>   <span class="token comment">// response request using msp sequence as command</span>
    CRSF_FRAMETYPE_MSP_RESP <span class="token operator">=</span> <span class="token number">0x7B</span><span class="token punctuation">,</span>  <span class="token comment">// reply with 58 byte chunked binary</span>
    CRSF_FRAMETYPE_MSP_WRITE <span class="token operator">=</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token comment">// write with 8 byte chunked binary (OpenTX outbound telemetry buffer limit)</span>
<span class="token punctuation">}</span> crsf_frame_type_e<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{</span>
    CRSF_ADDRESS_BROADCAST <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_USB <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_TBS_CORE_PNP_PRO <span class="token operator">=</span> <span class="token number">0x80</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RESERVED1 <span class="token operator">=</span> <span class="token number">0x8A</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_CURRENT_SENSOR <span class="token operator">=</span> <span class="token number">0xC0</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_GPS <span class="token operator">=</span> <span class="token number">0xC2</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_TBS_BLACKBOX <span class="token operator">=</span> <span class="token number">0xC4</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_FLIGHT_CONTROLLER <span class="token operator">=</span> <span class="token number">0xC8</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RESERVED2 <span class="token operator">=</span> <span class="token number">0xCA</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RACE_TAG <span class="token operator">=</span> <span class="token number">0xCC</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RADIO_TRANSMITTER <span class="token operator">=</span> <span class="token number">0xEA</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_CRSF_RECEIVER <span class="token operator">=</span> <span class="token number">0xEC</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_CRSF_TRANSMITTER <span class="token operator">=</span> <span class="token number">0xEE</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> crsf_addr_e<span class="token punctuation">;</span></code></pre>

            </div>
            
        </div>
    </div>

    <div class="container-md d-none d-print-block">
        <div class="row justify-content-center">
            
            <div class="col mr-auto ml-auto">
                 <h1>Week 7</h1>
<p><strong>PCB Design</strong></p>
<p>This week was mostly spent finishing the schematic and PCB layout for the flight controller. Both had reached a good point last week, and so the remaining efforts were implementing the IMU recommended designs, touching up the PCB component positions, silkscreen references, routing power traces, and cleaning up traces and ground planes to maximize signal integrity and current capacity, and minimize voltage drop and noise.</p>
<p>Again, I won’t show how the sausage is made too much, as it is a very, very iterative process and stuff keeps moving around on the PCB until I am satisfied with its position.</p>
<p>However, as things move around, the optimal location to have the signal pins originate off the microcontroller can change. So, in addition to selecting optimal final locations for the components, I frequently checked the datasheet, and a handy ST tool to check which UARTs, SPI busses, etc. could be enabled on which IO pins.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image.png" class="figure-img img-fluid rounded" alt="Alt text" title="STM32F446 pin mappings"><figcaption class="figure-caption text-center" align="center">STM32F446 pin mappings</figcaption></figure></div></p>
<p>Using this tool, I could validate that my pin configuration was workable with my physical layout, and then implement that on my schematic.</p>
<p>Implementing the IMU was mildly interesting, as I want the capability to use either the MPU9250, the LSM6DS3, or both. So in addition to adding the recommended parts, caps, etc., I added a network of 0 ohm resistor switches to enable the desired configuration as needed.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-1.png" class="figure-img img-fluid rounded" alt="Alt text" title="Dual IMU configuration"><figcaption class="figure-caption text-center" align="center">Dual IMU configuration</figcaption></figure></div></p>
<p>I also added the PI Zero connector that I had put off for last, selecting a part of the Pi header to interface to that contains the UART, +5V, and ground. This is pins 1 through 10 at the far edge of the PI PCB. This ended up being a relatively convenient spot after I moved a couple things out of its way.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-2.png" class="figure-img img-fluid rounded" alt="Alt text" title="Pi Zero pinout"><figcaption class="figure-caption text-center" align="center">Pi Zero pinout</figcaption></figure></div></p>
<p>Now that the part was in the ~mostly correct spot, I had to ensure that the connector would line up perfectly by looking up the exact dimensions of the board, and by verifying the setup by printing a to-scale version of the board and checking it against the Pi Zero I own.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-3.png" class="figure-img img-fluid rounded" alt="Alt text" title="Pi Zero dimensions"><figcaption class="figure-caption text-center" align="center">Pi Zero dimensions</figcaption></figure></div></p>
<p>Using these measurements, I worked to place it in what I believed was the best position. Then I printed off the too scale version and compared. I noticed that while all the corner holes were properly aligned, the connector was about a millimeter too far to the right. I then readjusted and printed again. Much better! A visual check shows the pins at the exact right spot.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-4.png" class="figure-img img-fluid rounded" alt="Alt text" title="PCB drill and borders plot"><figcaption class="figure-caption text-center" align="center">PCB drill and borders plot</figcaption></figure></div></p>
<p><img src="image-5.png" alt="Alt text"></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-6.png" class="figure-img img-fluid rounded" alt="Alt text" title="PCB size comparison"><figcaption class="figure-caption text-center" align="center">PCB size comparison</figcaption></figure></div></p>
<p>After much additional moving and redrawing, I got the board to a physically and electrically satisfactory point, with correct footprint positions, trace widths, silkscreen, etc.</p>
<p>The result looks like this.</p>
<p><img src="image-7.png" alt="Alt text"></p>
<p><img src="image-8.png" alt="Alt text"></p>
<p><img src="image-9.png" alt="Alt text"></p>
<p><img src="image-10.png" alt="Alt text"></p>
<p><strong>Radio Code</strong></p>
<p>I also revisited my radio CRSF interpretation code this week, in order to improve my relatively hacky code – which worked but performed almost no data validation (dangerous!), and was very inefficient.</p>
<p>For the new design, I chose a circular buffer, where the ‘start’ of the buffer would be shifted up until the end of the buffer, and then back around, rather than shifting the buffer contents while looking for a valid packet. This is significantly more efficient. Once it sees a valid starting character, it places a struct pointer at that location in memory, and begins to decode the data from that position, pulling out descriptors like the frame length from the point indicated my the struct definition. If needed, the ‘rolled over’ part of memory in the circular buffer is copied over to free space at the end of the buffer so the data frame is contiguous. Then the address, frame type, and CRC are checked. If these are valid, then the channel data is copied over to the global location for the latest radio channel data.</p>
<p>This system actually worked almost perfectly first try, which was great! I only had to fix a couple pointer casts and offsets, and the system was good to go. Another benefit is I went to the source code on the ELRS site and used their #defines and enums, so that my code is using not only the right values, but the canonical names for each field.</p>
<pre class="language-c"><code class="language-c">
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>crsf_addr_e<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>rx_buffer_start<span class="token punctuation">)</span> <span class="token operator">==</span> CRSF_ADDRESS_FLIGHT_CONTROLLER<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">//go through and attempt to parse</span>
  <span class="token comment">//place the data struct at this location and see if it passes</span>
  <span class="token comment">//first task is to verify the length is within bounds, and</span>
  <span class="token comment">//that the message type is what we're looking for</span>
  <span class="token comment">//Then verify it has a valid CRC</span>
  <span class="token comment">//move everything from the beginning of memory to</span>

  <span class="token class-name">crsf_packet_t</span><span class="token operator">*</span> crsf_packet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">crsf_packet_t</span><span class="token operator">*</span><span class="token punctuation">)</span>rx_buffer_start<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>type <span class="token operator">==</span> CRSF_FRAMETYPE_RC_CHANNELS_PACKED<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>frame_size <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">crsf_channels_t</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token comment">/*type, crc, and payload*/</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//validate CRC</span>

      <span class="token comment">//copy everything from bottom to the rx_buffer_start point into the upper half of the array to make it contiguous</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>rx_buffer <span class="token operator">+</span> BUFFER_SIZE<span class="token punctuation">,</span> rx_buffer<span class="token punctuation">,</span> rx_buffer_start<span class="token operator">-</span>rx_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">uint8_t</span> calculated_crc <span class="token operator">=</span> <span class="token function">calc_crc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">crsf_channels_t</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token comment">/*don't include the CRC in the CRC calc haha*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">uint8_t</span> rx_crc <span class="token operator">=</span> crsf_packet<span class="token operator">-&gt;</span>crc<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>rx_crc <span class="token operator">==</span> calculated_crc<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token comment">//valid packet</span>
        <span class="token comment">//TODO save the last 30 or so channel packets for filtering if needed</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>saved_channel_data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>crsf_packet<span class="token operator">-&gt;</span>channels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">crsf_channels_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-12.png" class="figure-img img-fluid rounded" alt="Alt text" title="Data streaming in"><figcaption class="figure-caption text-center" align="center">Data streaming in</figcaption></figure></div></p>
<pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> ch0 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch1 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch2 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch3 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch4 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch5 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch6 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch7 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch8 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch9 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch10 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch11 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch12 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch13 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch14 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ch15 <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">crsf_channels_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> device_addr<span class="token punctuation">;</span> <span class="token comment">// from crsf_addr_e</span>
    <span class="token class-name">uint8_t</span> frame_size<span class="token punctuation">;</span>  <span class="token comment">// counts size after this byte, so it must be the payload size + 2 (type and crc)</span>
    <span class="token class-name">uint8_t</span> type<span class="token punctuation">;</span>        <span class="token comment">// from crsf_frame_type_e</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">crsf_header_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
	<span class="token class-name">crsf_header_t</span> header<span class="token punctuation">;</span>
	<span class="token class-name">crsf_channels_t</span> channels<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span> crc<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">crsf_packet_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{</span>
    CRSF_FRAMETYPE_GPS <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_BATTERY_SENSOR <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_LINK_STATISTICS <span class="token operator">=</span> <span class="token number">0x14</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_RC_CHANNELS_PACKED <span class="token operator">=</span> <span class="token number">0x16</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_ATTITUDE <span class="token operator">=</span> <span class="token number">0x1E</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_FLIGHT_MODE <span class="token operator">=</span> <span class="token number">0x21</span><span class="token punctuation">,</span>
    <span class="token comment">// Extended Header Frames, range: 0x28 to 0x96</span>
    CRSF_FRAMETYPE_DEVICE_PING <span class="token operator">=</span> <span class="token number">0x28</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_DEVICE_INFO <span class="token operator">=</span> <span class="token number">0x29</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_PARAMETER_SETTINGS_ENTRY <span class="token operator">=</span> <span class="token number">0x2B</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_PARAMETER_READ <span class="token operator">=</span> <span class="token number">0x2C</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_PARAMETER_WRITE <span class="token operator">=</span> <span class="token number">0x2D</span><span class="token punctuation">,</span>
    CRSF_FRAMETYPE_COMMAND <span class="token operator">=</span> <span class="token number">0x32</span><span class="token punctuation">,</span>
    <span class="token comment">// MSP commands</span>
    CRSF_FRAMETYPE_MSP_REQ <span class="token operator">=</span> <span class="token number">0x7A</span><span class="token punctuation">,</span>   <span class="token comment">// response request using msp sequence as command</span>
    CRSF_FRAMETYPE_MSP_RESP <span class="token operator">=</span> <span class="token number">0x7B</span><span class="token punctuation">,</span>  <span class="token comment">// reply with 58 byte chunked binary</span>
    CRSF_FRAMETYPE_MSP_WRITE <span class="token operator">=</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token comment">// write with 8 byte chunked binary (OpenTX outbound telemetry buffer limit)</span>
<span class="token punctuation">}</span> crsf_frame_type_e<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{</span>
    CRSF_ADDRESS_BROADCAST <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_USB <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_TBS_CORE_PNP_PRO <span class="token operator">=</span> <span class="token number">0x80</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RESERVED1 <span class="token operator">=</span> <span class="token number">0x8A</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_CURRENT_SENSOR <span class="token operator">=</span> <span class="token number">0xC0</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_GPS <span class="token operator">=</span> <span class="token number">0xC2</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_TBS_BLACKBOX <span class="token operator">=</span> <span class="token number">0xC4</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_FLIGHT_CONTROLLER <span class="token operator">=</span> <span class="token number">0xC8</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RESERVED2 <span class="token operator">=</span> <span class="token number">0xCA</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RACE_TAG <span class="token operator">=</span> <span class="token number">0xCC</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_RADIO_TRANSMITTER <span class="token operator">=</span> <span class="token number">0xEA</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_CRSF_RECEIVER <span class="token operator">=</span> <span class="token number">0xEC</span><span class="token punctuation">,</span>
    CRSF_ADDRESS_CRSF_TRANSMITTER <span class="token operator">=</span> <span class="token number">0xEE</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> crsf_addr_e<span class="token punctuation">;</span></code></pre>

            </div>
            
        </div>
    </div>

<!--<div class="b-example-divider"></div>-->

<div class="container d-print-none">
  <footer class="flex-wrap border-top">
      <p class="text-center text-muted">© 2023 Michael Langford. Built with 11ty.</p>
  </footer>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  <script src="/assets/js/index.js"></script>
  <script data-goatcounter="https://michaellangford99.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>
  </body>
</html>
