
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="google-site-verification" content="jWYz4n1G8T7OHT4uWrEfZc6Qx-KFsPUYCC6oLXvfJHs">

    <!-- Bootstrap CSS -->
   <title>ECE477 Drone - Week 16</title> 
   
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!---<link rel="stylesheet" href="/assets/css/prism-vsc-dark-plus.css"/>  -->
    <!---<link href="https://unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet"> -->
   <!--- <link rel="stylesheet" href="/assets/css/prism-vs.css"/>    -->
   <link rel="stylesheet" href="/assets/css/prism-vsc-dark-plus.css">
    <link rel="stylesheet" href="/assets/css/clean-blog.css">
    
  </head>
  <body>


<nav class="navbar navbar-expand-lg bg-body-tertiary bg-dark border-bottom border-bottom-dark d-print-none" data-bs-theme="dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Michaelangelo</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">

    
    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
      <li class="nav-item">
        <a class="nav-link" href="/hiking/">Hiking &amp; Photography</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/engineering/">Engineering</a>
      </li>
    </ul>

<!--
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="#">Home</a>
        </li>

        <li class="nav-item"><a class="nav-link" href="#">Hiking & Photograpy</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Engineering</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Computer Graphics</a></li>       
        <li class="nav-item"><a class="nav-link" href="#">Thoughts</a></li>
        
        
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Dropdown
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">Action</a></li>
            <li><a class="dropdown-item" href="#">Another action</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">Something else here</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled">Disabled</a>
        </li>


      </ul>
-->

      <!--<form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Search</button>
      </form>-->
    </div>
  </div>
</nav>
    
<div class="bg-image p-5 text-center shadow-1-strong mb-2 text-white d-print-none" style="background-image: url('/assets/images/crestone.jpg'); background-position: center; background-size:cover;">
<div style="padding: 100px 0 130px ">
  <h1 class="mb-2 h1">ECE477 Drone - Week 16</h1>
  <p>
    
  </p>
</div>
</div>

<!--<div class="container-md">
  <div class="alert alert-primary" role="alert">
    
  </div>
</div>-->

    <div class="container-md d-print-none">
        <div class="row justify-content-center">
            
            <div class="col-md-9 mr-auto ml-auto">
                 <h1>Week 16</h1>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_6637.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Flight!"><figcaption class="figure-caption text-center" align="center">Flight!</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_6642.jpg" class="figure-img img-fluid rounded" alt="alt text" title="From below"><figcaption class="figure-caption text-center" align="center">From below</figcaption></figure></div></p>
<div id="wpnE13KWtOQ" class="eleventy-plugin-youtube-embed" style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/wpnE13KWtOQ" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p><strong>Key Points</strong></p>
<p>Last week was the drone’s first flight, and subsequent tuning of the IMU signal processing chain and the PID loops.</p>
<p>Most of this involved setting the correct gains on the accelerometer noise estimation, changing the decimation factor and low pass filter bandwidth for the motor output, and drastically increasing derivative feedback in the PID loops.</p>
<p>After flight tests showed the drone to be very controllable and quite stable, I moved on to implementing auto-throttle, where the drone will maintain a precise height off the ground using LiDAR, without input from the pilot. This took a couple days due to the difficulty and danger of testing the system, as well as improper tuning of the PID loop. After figuring out some filtering strategies to handle the low update rate of the LiDAR data impacting the derivative feedback to the PID loop, and some additional PID tuning, the PID control loop now easily and quickly locks onto the height desired after a switch is thrown on the remote.</p>
<p>In terms of autonomous functionality, I mounted the PI Zero onto the drone, created the connector solution from the Pi to the flight controller, and assisted my team members who were responsible for the autonomous functionality in building the LiDAR wire harness, soldering the harness to the Pi, testing it, and configuring the Pi for use. I also implemented an automatic landing system to land the Pi once the target object is found, however this we are unable to test with the propellers on at the moment.</p>
<p>In totality, I am very happy with the performance of the flight controller on the drone, although I would really like to spend more time tuning the signal chain and utilize the second IMU to really dial in the stability and accuracy of the attitude estimation algorithm.</p>
<p>I am not so happy with the navigation system, as it was implemented too late to be properly tested, integrated, and debugged, although more progress was made on it than I feared. Altogether, it demonstrates that the system foundation works very well as a whole, and is a great starting point for more interesting development using the STM32 flight controller + Pi nav computer system. I am excited to try implementing the system on a smaller drone platform, as well as trying to put a GPS and additional electronics on the larger drone, as it has so much thrust to spare. I also want to analyze the flight data from the drone and see if any additional kinematic information can be estimated using the IMU to assist with flight, such as tracking velocity, enhancing hovering ability, etc.</p>
<div id="g4PSVRbhDk8" class="eleventy-plugin-youtube-embed" style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/g4PSVRbhDk8" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>Boot log:</p>
<pre class="language-c"><code class="language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ECE477 STM32F446RET6 Flight Controller V0
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>

USB_USART<span class="token operator">:</span>
	USB_USART_BAUDRATE<span class="token operator">:</span>      <span class="token number">115200</span>
	CLOCK_RATE<span class="token operator">:</span>              <span class="token number">90000000</span>
	USB_USART_CLOCK_RATE<span class="token operator">:</span>    <span class="token number">90000000</span>
	USB_USART_DIV<span class="token operator">:</span>           <span class="token number">48</span>
	USB_USART_DIV_FRACTION<span class="token operator">:</span>  <span class="token number">13</span>
	USB_USART_DIV_MANTISSA<span class="token operator">:</span>  <span class="token number">48</span>
SYSTICK<span class="token operator">:</span>
	SYSTICK_LOAD<span class="token operator">:</span>		<span class="token number">22499</span>
	AHB_CLOCK<span class="token operator">:</span>		<span class="token number">180000000</span>
	AHB_CLOCK_DIV_8<span class="token operator">:</span>	<span class="token number">22500000</span>
RX_USART<span class="token operator">:</span>
	RX_USART_BAUDRATE<span class="token operator">:</span>      <span class="token number">420000</span>
	CLOCK_RATE<span class="token operator">:</span>             <span class="token number">90000000</span>
	RX_USART_CLOCK_RATE<span class="token operator">:</span>    <span class="token number">90000000</span>
	RX_USART_DIV<span class="token operator">:</span>           <span class="token number">13</span>
	RX_USART_DIV_FRACTION<span class="token operator">:</span>  <span class="token number">6</span>
	RX_USART_DIV_MANTISSA<span class="token operator">:</span>  <span class="token number">13</span>
	CRSF_RX_BAUDRATE<span class="token operator">:</span>       <span class="token number">420000</span>
	CRSF_NUM_CHANNELS<span class="token operator">:</span>      <span class="token number">16</span>
	CRSF_CHANNEL_VALUE_MIN<span class="token operator">:</span> <span class="token number">172</span>
	CRSF_CHANNEL_VALUE_MID<span class="token operator">:</span> <span class="token number">992</span>
	CRSF_CHANNEL_VALUE_MAX<span class="token operator">:</span> <span class="token number">1811</span>
	CRSF_MAX_PACKET_LEN<span class="token operator">:</span>    <span class="token number">64</span>
PI_USART<span class="token operator">:</span>
	PI_USART_BAUDRATE<span class="token operator">:</span>      <span class="token number">115200</span>
	CLOCK_RATE<span class="token operator">:</span>             <span class="token number">45000000</span>
	PI_USART_CLOCK_RATE<span class="token operator">:</span>    <span class="token number">45000000</span>
	PI_USART_DIV<span class="token operator">:</span>           <span class="token number">24</span>
	PI_USART_DIV_FRACTION<span class="token operator">:</span>  <span class="token number">6</span>
	PI_USART_DIV_MANTISSA<span class="token operator">:</span>  <span class="token number">24</span>
	PI_FRAME_START_CODE<span class="token operator">:</span>    <span class="token number">65</span>
	PI_FRAME_END_CODE<span class="token operator">:</span>      <span class="token number">66</span>
PWM<span class="token operator">:</span>
	PWM_FREQ<span class="token operator">:</span>        <span class="token number">3800</span>
	PWM_PERIOD <span class="token punctuation">[</span>uS<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">263.157898</span>
	MIN_PULSE  <span class="token punctuation">[</span>uS<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">125</span>
	MAX_PULSE  <span class="token punctuation">[</span>uS<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">250</span>
	PWM_ARR<span class="token operator">:</span>         <span class="token number">5262</span>
	UPPERBOUNDCRRX<span class="token operator">:</span>  <span class="token number">5000</span>
	LOWERBOUNDCRRX<span class="token operator">:</span>  <span class="token number">2500</span>
	RANGE<span class="token operator">:</span>           <span class="token number">2500</span>
SPI1<span class="token operator">:</span>
	SPI_CR1_BR_PCLOCK_DIV_32<span class="token operator">:</span> <span class="token number">0x20</span>
	SPI_PCLOCK_DIV_32<span class="token operator">:</span>        <span class="token number">2812500</span>
LSM6DSO Calibration<span class="token operator">:</span>
	gyro_cal_x<span class="token operator">:</span> <span class="token number">4</span>
	gyro_cal_y<span class="token operator">:</span> <span class="token number">14</span>
	gyro_cal_z<span class="token operator">:</span> <span class="token number">0</span>
MPU6500 Calibration<span class="token operator">:</span>
	gyro_cal_x<span class="token operator">:</span> <span class="token number">6419</span>
	gyro_cal_y<span class="token operator">:</span> <span class="token number">5340</span>
	gyro_cal_z<span class="token operator">:</span> <span class="token number">0</span></code></pre>
<p><strong>Auto-throttle</strong></p>
<p>In order to implement auto-throttle, or the ability to maintain a dictated height off the ground autonomously, I needed to integrate Santiago’s I2C Lidar code, mount the LiDAR, write the control loop, and debug any issues I came across.</p>
<p>First, I and Santiago integrated the LiDAR code that he’d written and merged with my flight controller code, and verified that the system still booted and ran properly with the I2C enabled, but without making any calls to the LiDAR driver.</p>
<p>Next I installed the LiDAR, which entailed soldering the LiDAR connector on the PCB, mounting the LiDAR, and routing cable to it in such a way that the LiDAR would be removeable, but that the cables couldn’t be sliced by the motors. I also had to create a connector on the flight controller so that the entire cable could be disconnected if necessary.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_20221202_172512381_HDR.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 1. New I2C connector implemented"><figcaption class="figure-caption text-center" align="center">Fig. 16- 1. New I2C connector implemented</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-1.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 2. LiDAR wiring to flight controller"><figcaption class="figure-caption text-center" align="center">Fig. 16- 2. LiDAR wiring to flight controller</figcaption></figure></div></p>
<p>After completing the wiring to the flight controller, I mounted the LiDAR on one of the outer arms of the drone, with a piece of foam in between. I wrapped the communication cabling around the arm to take up all the slack and prevent it from bouncing up into the rotors.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_20221209_103429158_HDR.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 3. Downward facing LiDAR mounted and ready"><figcaption class="figure-caption text-center" align="center">Fig. 16- 3. Downward facing LiDAR mounted and ready</figcaption></figure></div></p>
<p>I then tested the newly mounted LiDAR running in the main loop, which successfully showed the LiDAR data streaming in. Interestingly, if the sensor detects nothing, it returns a distance of zero, rather than its max distance of 600mm. To make the sensor work with my coming control loop, I added some quick logic to change this 0 distance to 600mm.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-3.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 4. LiDAR data from moving hand up and down over sensor."><figcaption class="figure-caption text-center" align="center">Fig. 16- 4. LiDAR data from moving hand up and down over sensor.</figcaption></figure></div></p>
<p>After testing what would happen if the I2C cable came loose, or the communication with the LiDAR hung during the execution of the main loop, it became clear that any failure would result in the main loop hanging, and loss of control of the drone.</p>
<p>To combat this in the short time available, instead of implementing the I2C distance monitoring in another thread, I implemented a watchdog in the Systick timing interrupt.</p>
<p>This watchdog watches to see if a flag gets reset, and if the flag is not reset for 50 executions of the Systick interrupt (a 1ms interrupt), so 50ms, the motor PWM values are set to zero which will immediately cut the motors. This means the drone will basically fall out of the air, but this is significantly better than it continuing to fly off in a random direction or tumble uncontrollably.</p>
<pre class="language-cpp"><code class="language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB_CLOCK</span> 		<span class="token expression">SystemCoreClock		</span><span class="token comment">//48 MHz</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB_CLOCK_DIV_8</span> <span class="token expression"><span class="token punctuation">(</span>AHB_CLOCK<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>	</span><span class="token comment">//6 MHz</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYSTICK_INT_FREQ</span> <span class="token expression"><span class="token number">1000</span>			</span><span class="token comment">//1KHz desired interrupt frequency</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYSTICK_LOAD</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>AHB_CLOCK_DIV_8<span class="token operator">/</span>SYSTICK_INT_FREQ<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">init_SYSTICK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SYSTICK_LOAD<span class="token punctuation">;</span>
	SysTick<span class="token operator">-&gt;</span>VAL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_TICKINT_Msk <span class="token operator">|</span> SysTick_CTRL_ENABLE_Msk<span class="token comment">/* | SysTick_CTRL_CLKSOURCE_Msk*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SYSTICK:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\tSYSTICK_LOAD:		%d\n"</span><span class="token punctuation">,</span> SYSTICK_LOAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\tAHB_CLOCK:		%d\n"</span><span class="token punctuation">,</span> AHB_CLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\tAHB_CLOCK_DIV_8:	%d\n"</span><span class="token punctuation">,</span> AHB_CLOCK_DIV_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">uint8_t</span> watchdog <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">uint32_t</span> ticks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ticks<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token comment">//GPIOC-&gt;ODR ^= 0x1 &lt;&lt; 13;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check_arm_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>watchdog <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			pwm_output_t zeros<span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

			<span class="token function">set_PWM_duty_cycle</span><span class="token punctuation">(</span>zeros<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//that way watchdog won't rollover.</span>
			watchdog<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		watchdog <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Once I was satisfied with the safety of the code, I had to implement the control loop. I used another PID loop using my same PID loop library code. After spending some time setting bounds on the PID output and attempting to fly it using only proportional feedback (P) in the control loop, I realized that it desperately needed to use derivative feedback to avoid either not being able to control the height of the drone or entering an unstable oscillation, due to the physical transfer function of the drone being a falling mass.</p>
<p>After adding derivative feedback to the PID loop tune, I noticed that nothing was changing the motor output plot. After some thinking and debugging, I quickly realized that this was due to the sudden change and (relative to the main flight loop) slow update rate of the LiDAR data. Instead of smoothly transitioning from one distance reading to the next, it would jump after an update, making the transition instantly. This resulted in 1 sample of the derivative feedback loop reacting to the change, but this 1 outlier would have no effect on the motor output, as the next motor output sample generated would go right back to the previous value before the value changed.</p>
<p>To combat this, I first implemented a FIR filter to induce a smooth change in the data, however this proved computationally intensive, and had too low of cutoff frequency. So instead, I utilize a single pole IIR filter to efficiently allow the newly measured value to be smoothly approached by the computed filter output, without sudden jumps, but also with minimal delay as opposed to delay induced by length of FIR filters.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UPDATE_PERIOD</span> <span class="token expression"><span class="token number">100</span></span></span>
<span class="token keyword">static</span> <span class="token keyword">int</span> l<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">update_TMF8801</span><span class="token punctuation">(</span>TMF8801_t<span class="token operator">*</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	l<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&gt;</span> UPDATE_PERIOD<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token function">read_distance</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//do some filtering here</span>
	<span class="token keyword">float</span> fdist <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>distance<span class="token punctuation">;</span>
	filtered_distance <span class="token operator">+=</span> <span class="token number">0.02</span><span class="token operator">*</span><span class="token punctuation">(</span>fdist <span class="token operator">-</span> filtered_distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>After implementing this filter, the data smoothly changed between updates of the data, with the settling time of the filter approximately equal to the period of the LiDAR update routine.</p>
<p>With that issue fixed, implementing derivative feedback gave a noticeable impact on the motor outputs in the data plot. With this boosting my confidence, I tried another flight test, which yielded a slightly janky but working auto-throttle test! I retuned the PID loop accordingly, and the auto-throttle now works excellently, quickly reacting to any change in LiDAR reading and swiftly locking on to the targe height.</p>
<p>With this implemented, I can now fly the drone with one hand, only steering it laterally. No throttle necessary!</p>
<p>TODO: insert video</p>
<p><strong>Pi assembly</strong></p>
<p>For the autonomous section of the drone, I needed to mount the Pi Zero along with the flight controller. They are designed with the same form factor intentionally, so that the zero can plug directly into the flight controller to communicate with it and send guidance commands.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-4.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 7. Demo of mounting of Pi to flight controller blank board"><figcaption class="figure-caption text-center" align="center">Fig. 16- 7. Demo of mounting of Pi to flight controller blank board</figcaption></figure></div></p>
<p>Aside from the positioning of the boards, I had to figure out the connector interface from Pi to PCB. I ended up choosing a shorter than normal version of 0.1” female headers for the flight controller, plugging into slightly trimmed male headers on the Pi.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-5.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 8. Figuring out header sizing and flight controller mount."><figcaption class="figure-caption text-center" align="center">Fig. 16- 8. Figuring out header sizing and flight controller mount.</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-6.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 9. (Kinda grainy) Completed mounting interface."><figcaption class="figure-caption text-center" align="center">Fig. 16- 9. (Kinda grainy) Completed mounting interface.</figcaption></figure></div></p>
<p>With the Pi now receiving power and its UART connection through the above connector, the team set up SSH login through the USB port and tested UART communication with the flight controller using the existing code demo-ed using the Pi 3.</p>
<p>This ended being a massive pain due to some networking issues and a kernel setting that Owen fixed.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="ssh_failure_cropped.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 10. Not great...."><figcaption class="figure-caption text-center" align="center">Fig. 16- 10. Not great....</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="ssh_failure_cropped2.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 11. Also bad... SSH service won't start."><figcaption class="figure-caption text-center" align="center">Fig. 16- 11. Also bad... SSH service won't start.</figcaption></figure></div></p>
<p>However, at long last, we were able to plug in a USB cable to power the entire flight control &amp; navigation assembly. Then after booting, we could log in to the pi through SSH.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_20221206_153939253_HDR.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 12. SSH’ed into the Pi Zero"><figcaption class="figure-caption text-center" align="center">Fig. 16- 12. SSH’ed into the Pi Zero</figcaption></figure></div></p>
<p><strong>Flight logs</strong></p>
<p>With the Pi Zero communicating, the first thing implemented was logging all transmitted data from the Pi Zero to a timestamped log file, which Owen got working quite nicely. I then wrote some simple scripts to rename them for use on a Windows system, and to SCP them off the Pi from the root directory so I could pull them into MATLAB and run simulations and analysis on them.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="scr.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 13. SCP copy of log files over to Windows from Pi Zero"><figcaption class="figure-caption text-center" align="center">Fig. 16- 13. SCP copy of log files over to Windows from Pi Zero</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-7.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 14. Sample MATLAB plot of gyro data logged by Pi from flight controller."><figcaption class="figure-caption text-center" align="center">Fig. 16- 14. Sample MATLAB plot of gyro data logged by Pi from flight controller.</figcaption></figure></div></p>
<p><strong>Camera &amp; Autonomous mode</strong></p>
<p>Lastly, I tested the autonomous scripts Owen developed to test their integration with the flight controller, and with the slightly smaller camera used on the Pi Zero.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-8.png" class="figure-img img-fluid rounded" alt="alt text" title=" "><figcaption class="figure-caption text-center" align="center"> </figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-9.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 15. Photos logged by Pi Zero viewed through remote login via VNC"><figcaption class="figure-caption text-center" align="center">Fig. 16- 15. Photos logged by Pi Zero viewed through remote login via VNC</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-10.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 16. VNC Viewer showing file explorer with lots of photos."><figcaption class="figure-caption text-center" align="center">Fig. 16- 16. VNC Viewer showing file explorer with lots of photos.</figcaption></figure></div></p>
<p>With the camera working nicely, I tested the steering commands coming from the Pi, ensuring that they were being properly parsed and, when in fully autonomous mode, passed along to the control loops as if they were normal radio control stick inputs.</p>
<p>After editing my control loop code to conditionally take these values as the inputs instead of the control stick values, I both got the commanded steering values from the Pi to come through, but also to clearly control the motors when in auto mode.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-11.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 17. Motor values show steering commands resulting in control loop attempting to drive drone to commanded attitude."><figcaption class="figure-caption text-center" align="center">Fig. 16- 17. Motor values show steering commands resulting in control loop attempting to drive drone to commanded attitude.</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-12.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 18. Raw commanded attitude data from Pi Zero. Pi sends pulses of positive steering commands to nudge drone forward."><figcaption class="figure-caption text-center" align="center">Fig. 16- 18. Raw commanded attitude data from Pi Zero. Pi sends pulses of positive steering commands to nudge drone forward.</figcaption></figure></div></p>
<p>Lastly, I implemented a simple landing sequence to land the drone upon it finding the visual target. This meant that, while in auto mode, if a ‘found object’ command was sent, the drone would immediately begin to descend and land by reducing its target height above ground, and its throttle center point that the control loop superimposes its feedback upon.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="landing.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 19. Landing resulting in exponential decay of target elevation and motor throttle"><figcaption class="figure-caption text-center" align="center">Fig. 16- 19. Landing resulting in exponential decay of target elevation and motor throttle</figcaption></figure></div></p>

            </div>
            
        </div>
    </div>

    <div class="container-md d-none d-print-block">
        <div class="row justify-content-center">
            
            <div class="col mr-auto ml-auto">
                 <h1>Week 16</h1>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_6637.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Flight!"><figcaption class="figure-caption text-center" align="center">Flight!</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_6642.jpg" class="figure-img img-fluid rounded" alt="alt text" title="From below"><figcaption class="figure-caption text-center" align="center">From below</figcaption></figure></div></p>
<div id="wpnE13KWtOQ" class="eleventy-plugin-youtube-embed" style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/wpnE13KWtOQ" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p><strong>Key Points</strong></p>
<p>Last week was the drone’s first flight, and subsequent tuning of the IMU signal processing chain and the PID loops.</p>
<p>Most of this involved setting the correct gains on the accelerometer noise estimation, changing the decimation factor and low pass filter bandwidth for the motor output, and drastically increasing derivative feedback in the PID loops.</p>
<p>After flight tests showed the drone to be very controllable and quite stable, I moved on to implementing auto-throttle, where the drone will maintain a precise height off the ground using LiDAR, without input from the pilot. This took a couple days due to the difficulty and danger of testing the system, as well as improper tuning of the PID loop. After figuring out some filtering strategies to handle the low update rate of the LiDAR data impacting the derivative feedback to the PID loop, and some additional PID tuning, the PID control loop now easily and quickly locks onto the height desired after a switch is thrown on the remote.</p>
<p>In terms of autonomous functionality, I mounted the PI Zero onto the drone, created the connector solution from the Pi to the flight controller, and assisted my team members who were responsible for the autonomous functionality in building the LiDAR wire harness, soldering the harness to the Pi, testing it, and configuring the Pi for use. I also implemented an automatic landing system to land the Pi once the target object is found, however this we are unable to test with the propellers on at the moment.</p>
<p>In totality, I am very happy with the performance of the flight controller on the drone, although I would really like to spend more time tuning the signal chain and utilize the second IMU to really dial in the stability and accuracy of the attitude estimation algorithm.</p>
<p>I am not so happy with the navigation system, as it was implemented too late to be properly tested, integrated, and debugged, although more progress was made on it than I feared. Altogether, it demonstrates that the system foundation works very well as a whole, and is a great starting point for more interesting development using the STM32 flight controller + Pi nav computer system. I am excited to try implementing the system on a smaller drone platform, as well as trying to put a GPS and additional electronics on the larger drone, as it has so much thrust to spare. I also want to analyze the flight data from the drone and see if any additional kinematic information can be estimated using the IMU to assist with flight, such as tracking velocity, enhancing hovering ability, etc.</p>
<div id="g4PSVRbhDk8" class="eleventy-plugin-youtube-embed" style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/g4PSVRbhDk8" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>Boot log:</p>
<pre class="language-c"><code class="language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ECE477 STM32F446RET6 Flight Controller V0
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>

USB_USART<span class="token operator">:</span>
	USB_USART_BAUDRATE<span class="token operator">:</span>      <span class="token number">115200</span>
	CLOCK_RATE<span class="token operator">:</span>              <span class="token number">90000000</span>
	USB_USART_CLOCK_RATE<span class="token operator">:</span>    <span class="token number">90000000</span>
	USB_USART_DIV<span class="token operator">:</span>           <span class="token number">48</span>
	USB_USART_DIV_FRACTION<span class="token operator">:</span>  <span class="token number">13</span>
	USB_USART_DIV_MANTISSA<span class="token operator">:</span>  <span class="token number">48</span>
SYSTICK<span class="token operator">:</span>
	SYSTICK_LOAD<span class="token operator">:</span>		<span class="token number">22499</span>
	AHB_CLOCK<span class="token operator">:</span>		<span class="token number">180000000</span>
	AHB_CLOCK_DIV_8<span class="token operator">:</span>	<span class="token number">22500000</span>
RX_USART<span class="token operator">:</span>
	RX_USART_BAUDRATE<span class="token operator">:</span>      <span class="token number">420000</span>
	CLOCK_RATE<span class="token operator">:</span>             <span class="token number">90000000</span>
	RX_USART_CLOCK_RATE<span class="token operator">:</span>    <span class="token number">90000000</span>
	RX_USART_DIV<span class="token operator">:</span>           <span class="token number">13</span>
	RX_USART_DIV_FRACTION<span class="token operator">:</span>  <span class="token number">6</span>
	RX_USART_DIV_MANTISSA<span class="token operator">:</span>  <span class="token number">13</span>
	CRSF_RX_BAUDRATE<span class="token operator">:</span>       <span class="token number">420000</span>
	CRSF_NUM_CHANNELS<span class="token operator">:</span>      <span class="token number">16</span>
	CRSF_CHANNEL_VALUE_MIN<span class="token operator">:</span> <span class="token number">172</span>
	CRSF_CHANNEL_VALUE_MID<span class="token operator">:</span> <span class="token number">992</span>
	CRSF_CHANNEL_VALUE_MAX<span class="token operator">:</span> <span class="token number">1811</span>
	CRSF_MAX_PACKET_LEN<span class="token operator">:</span>    <span class="token number">64</span>
PI_USART<span class="token operator">:</span>
	PI_USART_BAUDRATE<span class="token operator">:</span>      <span class="token number">115200</span>
	CLOCK_RATE<span class="token operator">:</span>             <span class="token number">45000000</span>
	PI_USART_CLOCK_RATE<span class="token operator">:</span>    <span class="token number">45000000</span>
	PI_USART_DIV<span class="token operator">:</span>           <span class="token number">24</span>
	PI_USART_DIV_FRACTION<span class="token operator">:</span>  <span class="token number">6</span>
	PI_USART_DIV_MANTISSA<span class="token operator">:</span>  <span class="token number">24</span>
	PI_FRAME_START_CODE<span class="token operator">:</span>    <span class="token number">65</span>
	PI_FRAME_END_CODE<span class="token operator">:</span>      <span class="token number">66</span>
PWM<span class="token operator">:</span>
	PWM_FREQ<span class="token operator">:</span>        <span class="token number">3800</span>
	PWM_PERIOD <span class="token punctuation">[</span>uS<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">263.157898</span>
	MIN_PULSE  <span class="token punctuation">[</span>uS<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">125</span>
	MAX_PULSE  <span class="token punctuation">[</span>uS<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">250</span>
	PWM_ARR<span class="token operator">:</span>         <span class="token number">5262</span>
	UPPERBOUNDCRRX<span class="token operator">:</span>  <span class="token number">5000</span>
	LOWERBOUNDCRRX<span class="token operator">:</span>  <span class="token number">2500</span>
	RANGE<span class="token operator">:</span>           <span class="token number">2500</span>
SPI1<span class="token operator">:</span>
	SPI_CR1_BR_PCLOCK_DIV_32<span class="token operator">:</span> <span class="token number">0x20</span>
	SPI_PCLOCK_DIV_32<span class="token operator">:</span>        <span class="token number">2812500</span>
LSM6DSO Calibration<span class="token operator">:</span>
	gyro_cal_x<span class="token operator">:</span> <span class="token number">4</span>
	gyro_cal_y<span class="token operator">:</span> <span class="token number">14</span>
	gyro_cal_z<span class="token operator">:</span> <span class="token number">0</span>
MPU6500 Calibration<span class="token operator">:</span>
	gyro_cal_x<span class="token operator">:</span> <span class="token number">6419</span>
	gyro_cal_y<span class="token operator">:</span> <span class="token number">5340</span>
	gyro_cal_z<span class="token operator">:</span> <span class="token number">0</span></code></pre>
<p><strong>Auto-throttle</strong></p>
<p>In order to implement auto-throttle, or the ability to maintain a dictated height off the ground autonomously, I needed to integrate Santiago’s I2C Lidar code, mount the LiDAR, write the control loop, and debug any issues I came across.</p>
<p>First, I and Santiago integrated the LiDAR code that he’d written and merged with my flight controller code, and verified that the system still booted and ran properly with the I2C enabled, but without making any calls to the LiDAR driver.</p>
<p>Next I installed the LiDAR, which entailed soldering the LiDAR connector on the PCB, mounting the LiDAR, and routing cable to it in such a way that the LiDAR would be removeable, but that the cables couldn’t be sliced by the motors. I also had to create a connector on the flight controller so that the entire cable could be disconnected if necessary.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_20221202_172512381_HDR.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 1. New I2C connector implemented"><figcaption class="figure-caption text-center" align="center">Fig. 16- 1. New I2C connector implemented</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-1.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 2. LiDAR wiring to flight controller"><figcaption class="figure-caption text-center" align="center">Fig. 16- 2. LiDAR wiring to flight controller</figcaption></figure></div></p>
<p>After completing the wiring to the flight controller, I mounted the LiDAR on one of the outer arms of the drone, with a piece of foam in between. I wrapped the communication cabling around the arm to take up all the slack and prevent it from bouncing up into the rotors.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_20221209_103429158_HDR.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 3. Downward facing LiDAR mounted and ready"><figcaption class="figure-caption text-center" align="center">Fig. 16- 3. Downward facing LiDAR mounted and ready</figcaption></figure></div></p>
<p>I then tested the newly mounted LiDAR running in the main loop, which successfully showed the LiDAR data streaming in. Interestingly, if the sensor detects nothing, it returns a distance of zero, rather than its max distance of 600mm. To make the sensor work with my coming control loop, I added some quick logic to change this 0 distance to 600mm.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-3.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 4. LiDAR data from moving hand up and down over sensor."><figcaption class="figure-caption text-center" align="center">Fig. 16- 4. LiDAR data from moving hand up and down over sensor.</figcaption></figure></div></p>
<p>After testing what would happen if the I2C cable came loose, or the communication with the LiDAR hung during the execution of the main loop, it became clear that any failure would result in the main loop hanging, and loss of control of the drone.</p>
<p>To combat this in the short time available, instead of implementing the I2C distance monitoring in another thread, I implemented a watchdog in the Systick timing interrupt.</p>
<p>This watchdog watches to see if a flag gets reset, and if the flag is not reset for 50 executions of the Systick interrupt (a 1ms interrupt), so 50ms, the motor PWM values are set to zero which will immediately cut the motors. This means the drone will basically fall out of the air, but this is significantly better than it continuing to fly off in a random direction or tumble uncontrollably.</p>
<pre class="language-cpp"><code class="language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB_CLOCK</span> 		<span class="token expression">SystemCoreClock		</span><span class="token comment">//48 MHz</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB_CLOCK_DIV_8</span> <span class="token expression"><span class="token punctuation">(</span>AHB_CLOCK<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>	</span><span class="token comment">//6 MHz</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYSTICK_INT_FREQ</span> <span class="token expression"><span class="token number">1000</span>			</span><span class="token comment">//1KHz desired interrupt frequency</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYSTICK_LOAD</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>AHB_CLOCK_DIV_8<span class="token operator">/</span>SYSTICK_INT_FREQ<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">init_SYSTICK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SYSTICK_LOAD<span class="token punctuation">;</span>
	SysTick<span class="token operator">-&gt;</span>VAL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_TICKINT_Msk <span class="token operator">|</span> SysTick_CTRL_ENABLE_Msk<span class="token comment">/* | SysTick_CTRL_CLKSOURCE_Msk*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SYSTICK:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\tSYSTICK_LOAD:		%d\n"</span><span class="token punctuation">,</span> SYSTICK_LOAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\tAHB_CLOCK:		%d\n"</span><span class="token punctuation">,</span> AHB_CLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\tAHB_CLOCK_DIV_8:	%d\n"</span><span class="token punctuation">,</span> AHB_CLOCK_DIV_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">uint8_t</span> watchdog <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">uint32_t</span> ticks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ticks<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token comment">//GPIOC-&gt;ODR ^= 0x1 &lt;&lt; 13;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check_arm_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>watchdog <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			pwm_output_t zeros<span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			zeros<span class="token punctuation">.</span>duty_cycle_ch3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

			<span class="token function">set_PWM_duty_cycle</span><span class="token punctuation">(</span>zeros<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//that way watchdog won't rollover.</span>
			watchdog<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		watchdog <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Once I was satisfied with the safety of the code, I had to implement the control loop. I used another PID loop using my same PID loop library code. After spending some time setting bounds on the PID output and attempting to fly it using only proportional feedback (P) in the control loop, I realized that it desperately needed to use derivative feedback to avoid either not being able to control the height of the drone or entering an unstable oscillation, due to the physical transfer function of the drone being a falling mass.</p>
<p>After adding derivative feedback to the PID loop tune, I noticed that nothing was changing the motor output plot. After some thinking and debugging, I quickly realized that this was due to the sudden change and (relative to the main flight loop) slow update rate of the LiDAR data. Instead of smoothly transitioning from one distance reading to the next, it would jump after an update, making the transition instantly. This resulted in 1 sample of the derivative feedback loop reacting to the change, but this 1 outlier would have no effect on the motor output, as the next motor output sample generated would go right back to the previous value before the value changed.</p>
<p>To combat this, I first implemented a FIR filter to induce a smooth change in the data, however this proved computationally intensive, and had too low of cutoff frequency. So instead, I utilize a single pole IIR filter to efficiently allow the newly measured value to be smoothly approached by the computed filter output, without sudden jumps, but also with minimal delay as opposed to delay induced by length of FIR filters.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UPDATE_PERIOD</span> <span class="token expression"><span class="token number">100</span></span></span>
<span class="token keyword">static</span> <span class="token keyword">int</span> l<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">update_TMF8801</span><span class="token punctuation">(</span>TMF8801_t<span class="token operator">*</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	l<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&gt;</span> UPDATE_PERIOD<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token function">read_distance</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//do some filtering here</span>
	<span class="token keyword">float</span> fdist <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>distance<span class="token punctuation">;</span>
	filtered_distance <span class="token operator">+=</span> <span class="token number">0.02</span><span class="token operator">*</span><span class="token punctuation">(</span>fdist <span class="token operator">-</span> filtered_distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>After implementing this filter, the data smoothly changed between updates of the data, with the settling time of the filter approximately equal to the period of the LiDAR update routine.</p>
<p>With that issue fixed, implementing derivative feedback gave a noticeable impact on the motor outputs in the data plot. With this boosting my confidence, I tried another flight test, which yielded a slightly janky but working auto-throttle test! I retuned the PID loop accordingly, and the auto-throttle now works excellently, quickly reacting to any change in LiDAR reading and swiftly locking on to the targe height.</p>
<p>With this implemented, I can now fly the drone with one hand, only steering it laterally. No throttle necessary!</p>
<p>TODO: insert video</p>
<p><strong>Pi assembly</strong></p>
<p>For the autonomous section of the drone, I needed to mount the Pi Zero along with the flight controller. They are designed with the same form factor intentionally, so that the zero can plug directly into the flight controller to communicate with it and send guidance commands.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-4.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 7. Demo of mounting of Pi to flight controller blank board"><figcaption class="figure-caption text-center" align="center">Fig. 16- 7. Demo of mounting of Pi to flight controller blank board</figcaption></figure></div></p>
<p>Aside from the positioning of the boards, I had to figure out the connector interface from Pi to PCB. I ended up choosing a shorter than normal version of 0.1” female headers for the flight controller, plugging into slightly trimmed male headers on the Pi.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-5.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 8. Figuring out header sizing and flight controller mount."><figcaption class="figure-caption text-center" align="center">Fig. 16- 8. Figuring out header sizing and flight controller mount.</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-6.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 9. (Kinda grainy) Completed mounting interface."><figcaption class="figure-caption text-center" align="center">Fig. 16- 9. (Kinda grainy) Completed mounting interface.</figcaption></figure></div></p>
<p>With the Pi now receiving power and its UART connection through the above connector, the team set up SSH login through the USB port and tested UART communication with the flight controller using the existing code demo-ed using the Pi 3.</p>
<p>This ended being a massive pain due to some networking issues and a kernel setting that Owen fixed.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="ssh_failure_cropped.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 10. Not great...."><figcaption class="figure-caption text-center" align="center">Fig. 16- 10. Not great....</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="ssh_failure_cropped2.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 11. Also bad... SSH service won't start."><figcaption class="figure-caption text-center" align="center">Fig. 16- 11. Also bad... SSH service won't start.</figcaption></figure></div></p>
<p>However, at long last, we were able to plug in a USB cable to power the entire flight control &amp; navigation assembly. Then after booting, we could log in to the pi through SSH.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="IMG_20221206_153939253_HDR.jpg" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 12. SSH’ed into the Pi Zero"><figcaption class="figure-caption text-center" align="center">Fig. 16- 12. SSH’ed into the Pi Zero</figcaption></figure></div></p>
<p><strong>Flight logs</strong></p>
<p>With the Pi Zero communicating, the first thing implemented was logging all transmitted data from the Pi Zero to a timestamped log file, which Owen got working quite nicely. I then wrote some simple scripts to rename them for use on a Windows system, and to SCP them off the Pi from the root directory so I could pull them into MATLAB and run simulations and analysis on them.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="scr.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 13. SCP copy of log files over to Windows from Pi Zero"><figcaption class="figure-caption text-center" align="center">Fig. 16- 13. SCP copy of log files over to Windows from Pi Zero</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-7.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 14. Sample MATLAB plot of gyro data logged by Pi from flight controller."><figcaption class="figure-caption text-center" align="center">Fig. 16- 14. Sample MATLAB plot of gyro data logged by Pi from flight controller.</figcaption></figure></div></p>
<p><strong>Camera &amp; Autonomous mode</strong></p>
<p>Lastly, I tested the autonomous scripts Owen developed to test their integration with the flight controller, and with the slightly smaller camera used on the Pi Zero.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-8.png" class="figure-img img-fluid rounded" alt="alt text" title=" "><figcaption class="figure-caption text-center" align="center"> </figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-9.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 15. Photos logged by Pi Zero viewed through remote login via VNC"><figcaption class="figure-caption text-center" align="center">Fig. 16- 15. Photos logged by Pi Zero viewed through remote login via VNC</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-10.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 16. VNC Viewer showing file explorer with lots of photos."><figcaption class="figure-caption text-center" align="center">Fig. 16- 16. VNC Viewer showing file explorer with lots of photos.</figcaption></figure></div></p>
<p>With the camera working nicely, I tested the steering commands coming from the Pi, ensuring that they were being properly parsed and, when in fully autonomous mode, passed along to the control loops as if they were normal radio control stick inputs.</p>
<p>After editing my control loop code to conditionally take these values as the inputs instead of the control stick values, I both got the commanded steering values from the Pi to come through, but also to clearly control the motors when in auto mode.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-11.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 17. Motor values show steering commands resulting in control loop attempting to drive drone to commanded attitude."><figcaption class="figure-caption text-center" align="center">Fig. 16- 17. Motor values show steering commands resulting in control loop attempting to drive drone to commanded attitude.</figcaption></figure></div></p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="image-12.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 18. Raw commanded attitude data from Pi Zero. Pi sends pulses of positive steering commands to nudge drone forward."><figcaption class="figure-caption text-center" align="center">Fig. 16- 18. Raw commanded attitude data from Pi Zero. Pi sends pulses of positive steering commands to nudge drone forward.</figcaption></figure></div></p>
<p>Lastly, I implemented a simple landing sequence to land the drone upon it finding the visual target. This meant that, while in auto mode, if a ‘found object’ command was sent, the drone would immediately begin to descend and land by reducing its target height above ground, and its throttle center point that the control loop superimposes its feedback upon.</p>
<p><div class="d-flex justify-content-center"><figure class="figure justify-content-center"><img src="landing.png" class="figure-img img-fluid rounded" alt="alt text" title="Fig. 16- 19. Landing resulting in exponential decay of target elevation and motor throttle"><figcaption class="figure-caption text-center" align="center">Fig. 16- 19. Landing resulting in exponential decay of target elevation and motor throttle</figcaption></figure></div></p>

            </div>
            
        </div>
    </div>

<!--<div class="b-example-divider"></div>-->

<div class="container d-print-none">
  <footer class="flex-wrap border-top">
      <p class="text-center text-muted">© 2023 Michael Langford. Built with 11ty.</p>
  </footer>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  <script src="/assets/js/index.js"></script>
  <script data-goatcounter="https://michaellangford99.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>
  </body>
</html>
